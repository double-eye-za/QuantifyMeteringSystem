{% extends "base.html" %} {% block title %}Meter Details - Quantify Metering
System{% endblock %} {% block page_title %}Meter Details: {{ meter_id or 'N/A'
}}{% endblock %} {% block breadcrumb %}
<a href="{{ url_for('api_v1.dashboard') }}" class="hover:text-primary">Home</a>
<span class="mx-1">/</span>
<a href="{{ url_for('api_v1.meters_page') }}" class="hover:text-primary"
  >Meters</a
>
<span class="mx-1">/</span>
<span>Details</span>
{% endblock %} {% block content %}

<!-- Meter Overview -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
  <!-- Meter Info Card -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      Meter Information
    </h3>
    <div class="space-y-3">
      <div class="flex justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">Device EUI</span>
        <span
          class="text-sm font-mono font-medium text-gray-900 dark:text-white"
          >{{ meter.device_eui if meter else meter_id }}</span
        >
      </div>
      <div class="flex justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">Type</span>
        <span
          class="inline-flex items-center px-2 py-1 rounded text-xs {{ 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' if meter and meter.meter_type=='electricity' else ('bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300' if meter and meter.meter_type=='water' else 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300') }}"
        >
          <i
            class="fas {{ 'fa-bolt' if meter and meter.meter_type=='electricity' else ('fa-tint' if meter and meter.meter_type=='water' else 'fa-solar-panel') }} mr-1"
          ></i
          >{{ meter.meter_type|capitalize if meter else '—' }}
        </span>
      </div>
      <div class="flex justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">Device Status</span>
        <span
          class="inline-flex items-center px-2 py-1 rounded text-xs {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' if device_status=='online' else 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300' }}"
        >
          <i
            class="fas {{ 'fa-wifi' if device_status=='online' else 'fa-unlink' }} mr-1"
          ></i
          >{{ 'Online' if device_status=='online' else 'Offline' }}
        </span>
      </div>
      <div class="flex justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">Credit Status</span>
        <span
          class="inline-flex items-center px-2 py-1 rounded text-xs {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' if credit_status=='ok' else ('bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' if credit_status=='low' else 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300') }}"
        >
          <i
            class="fas {{ 'fa-circle' if credit_status=='ok' else ('fa-exclamation-triangle' if credit_status=='low' else 'fa-times-circle') }} mr-1"
          ></i
          >{{ 'Active' if credit_status=='ok' else ('Low' if
          credit_status=='low' else 'Disconnected') }}
        </span>
      </div>
      <div class="flex justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">Firmware</span>
        <span class="text-sm font-medium text-gray-900 dark:text-white"
          >{{ meter.firmware_version or '—' }}</span
        >
      </div>
      <div class="flex justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400"
          >Installation Date</span
        >
        <span class="text-sm font-medium text-gray-900 dark:text-white"
          >{{ meter.installation_date or '—' }}</span
        >
      </div>
    </div>
  </div>

  <!-- Location Card -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      Location
    </h3>
    <div class="space-y-3">
      <div class="flex justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">Estate</span>
        <span class="text-sm font-medium text-gray-900 dark:text-white"
          >{{ estate.name if estate else '—' }}</span
        >
      </div>
      <div class="flex justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">Unit</span>
        <span class="text-sm font-medium text-gray-900 dark:text-white"
          >{{ unit.unit_number if unit else '—' }}</span
        >
      </div>
      <div class="flex justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">Tenant</span>
        <span class="text-sm font-medium text-gray-900 dark:text-white"
          >{{ (resident.first_name ~ ' ' ~ resident.last_name) if resident else '—'
          }}</span
        >
      </div>
      <div class="flex justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400"
          >Concentrator</span
        >
        <span class="text-sm font-medium text-gray-900 dark:text-white"
          >DC450-WC-01</span
        >
      </div>
      <div class="flex justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">GPS</span>
        <span class="text-sm font-medium text-gray-900 dark:text-white"
          >-26.195, 28.034</span
        >
      </div>
    </div>
  </div>

  <!-- Current Balance Card -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      Current Balance
    </h3>
    <div class="text-center py-4">
      <div class="text-3xl font-bold text-gray-900 dark:text-white">
        R {{ (balance_value or 0) | format_number(2) }}
      </div>
      <div class="text-sm text-gray-600 dark:text-gray-400 mt-2">&nbsp;</div>
      <div class="mt-4 space-y-2">
        <!-- Debug: is_super_admin = {{ is_super_admin() }}, wallet = {{ 'exists' if wallet else 'none' }}, unit = {{ 'exists' if unit else 'none' }} -->
        {% if is_super_admin() %}
        <button
          id="topUpBtn"
          class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600"
        >
          <i class="fas fa-plus-circle mr-2"></i>Top Up
        </button>
        {% else %}
        <!-- Not super admin or missing wallet/unit -->
        {% endif %}
        <button
          class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600"
        >
          <i class="fas fa-history mr-2"></i>Transaction History
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm mb-6">
  <div class="border-b border-gray-200 dark:border-gray-700">
    <nav class="flex space-x-8 px-6" aria-label="Tabs">
      <button
        class="py-4 px-1 border-b-2 border-primary font-medium text-sm text-primary"
      >
        Real-time Data
      </button>
      <button
        class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
      >
        Configuration
      </button>
      <button
        class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
      >
        Events & Alarms
      </button>
      <button
        class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
      >
        Maintenance
      </button>
    </nav>
  </div>

  <!-- Tab Content: Real-time Data -->
  <div class="p-6">
    <!-- Live Readings -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <!-- Card 1: Today's Usage -->
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Today's Usage</span>
          <i class="fas fa-chart-line text-primary"></i>
        </div>
        <div class="text-2xl font-bold text-gray-900 dark:text-white" id="today-usage">
          —
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="today-cost">
          Loading...
        </div>
      </div>

      <!-- Card 2: Total Consumption -->
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Total Consumption</span>
          <i class="fas fa-bolt text-yellow-500"></i>
        </div>
        <div class="text-2xl font-bold text-gray-900 dark:text-white" id="total-reading">
          —
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="last-reading-time">
          Loading...
        </div>
      </div>

      <!-- Card 3: Device Status -->
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Device Status</span>
          <i class="fas fa-battery-full text-green-500" id="battery-icon"></i>
        </div>
        <div class="text-sm text-gray-900 dark:text-white space-y-1">
          <div>Battery: <span id="battery-level" class="font-bold">—</span></div>
          <div>Temp: <span id="temperature" class="font-bold">—</span></div>
          <div>Signal: <span id="signal-strength" class="font-bold">—</span></div>
        </div>
      </div>
    </div>

    <!-- Consumption Chart -->
    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">
          24-Hour Consumption
        </h4>
        <div class="flex space-x-2">
          <button
            data-period="hour"
            class="period-btn px-3 py-1 text-xs bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition-colors"
          >
            Hour
          </button>
          <button
            data-period="day"
            class="period-btn px-3 py-1 text-xs bg-primary text-white rounded-lg active"
          >
            Day
          </button>
          <button
            data-period="week"
            class="period-btn px-3 py-1 text-xs bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition-colors"
          >
            Week
          </button>
          <button
            data-period="month"
            class="period-btn px-3 py-1 text-xs bg-white dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition-colors"
          >
            Month
          </button>
        </div>
      </div>
      <div class="relative h-64">
        <canvas id="consumptionChart"></canvas>
      </div>
    </div>

    <!-- Recent Readings Table -->
    <div class="mt-6">
      <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
        Recent Readings
      </h4>
      <div class="overflow-x-auto">
        <table
          class="w-full text-sm text-left text-gray-500 dark:text-gray-400"
        >
          <thead
            class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
          >
            <tr>
              <th scope="col" class="px-6 py-3">Timestamp</th>
              <th scope="col" class="px-6 py-3">
                {% if meter and meter.meter_type == 'electricity' %}
                  Reading (kWh)
                {% elif meter and meter.meter_type == 'water' %}
                  Reading (L)
                {% elif meter and meter.meter_type == 'solar' %}
                  Reading (kWh)
                {% else %}
                  Reading
                {% endif %}
              </th>
              <th scope="col" class="px-6 py-3">Consumption</th>
              {% if meter and meter.meter_type == 'electricity' %}
                <th scope="col" class="px-6 py-3">Load (kW)</th>
                <th scope="col" class="px-6 py-3">Voltage (V)</th>
              {% elif meter and meter.meter_type == 'water' %}
                <th scope="col" class="px-6 py-3">Flow Rate (L/h)</th>
                <th scope="col" class="px-6 py-3">Temperature (°C)</th>
              {% elif meter and meter.meter_type == 'solar' %}
                <th scope="col" class="px-6 py-3">Load (kW)</th>
                <th scope="col" class="px-6 py-3">Voltage (V)</th>
              {% endif %}
              <th scope="col" class="px-6 py-3">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for r in recent_readings %}
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
              <td class="px-6 py-4">
                {{ (((r.reading_date or r.timestamp)[:19]) if (r.reading_date or
                r.timestamp) else '-')|replace('T',' ') }}
              </td>
              <td class="px-6 py-4 font-mono">
                {{ r.reading_value if r.reading_value is not none else '-' }}
              </td>
              <td class="px-6 py-4">
                {{ r.consumption_since_last if r.consumption_since_last is not none else '-' }}
              </td>
              {% if meter and meter.meter_type == 'electricity' %}
                <td class="px-6 py-4">
                  {{ r.power if r.power is not none else '-' }}
                </td>
                <td class="px-6 py-4">
                  {{ r.voltage if r.voltage is not none else '-' }}
                </td>
              {% elif meter and meter.meter_type == 'water' %}
                <td class="px-6 py-4">
                  {{ r.flow_rate if r.flow_rate is not none else '-' }}
                </td>
                <td class="px-6 py-4">
                  {{ r.temperature if r.temperature is not none else '-' }}
                </td>
              {% elif meter and meter.meter_type == 'solar' %}
                <td class="px-6 py-4">
                  {{ r.power if r.power is not none else '-' }}
                </td>
                <td class="px-6 py-4">
                  {{ r.voltage if r.voltage is not none else '-' }}
                </td>
              {% endif %}
              <td class="px-6 py-4">{{ r.status or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
  <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
    Quick Actions
  </h3>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <button
      class="px-4 py-3 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-lg hover:bg-green-200 dark:hover:bg-green-800"
    >
      <i class="fas fa-sync mr-2"></i>Force Read
    </button>
    <button
      class="px-4 py-3 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800"
    >
      <i class="fas fa-cog mr-2"></i>Configure
    </button>
    <button
      class="px-4 py-3 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-lg hover:bg-yellow-200 dark:hover:bg-yellow-800"
    >
      <i class="fas fa-bell mr-2"></i>Set Alert
    </button>
    <button
      class="px-4 py-3 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg hover:bg-red-200 dark:hover:bg-red-800"
    >
      <i class="fas fa-power-off mr-2"></i>Disconnect
    </button>
  </div>
</div>

<!-- Top Up Modal -->
<div id="topUpModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
    <div class="flex items-center justify-between pb-3 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
        <i class="fas fa-plus-circle text-primary mr-2"></i>Top Up Wallet
      </h3>
      <button id="closeTopUpModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <div class="mt-4">
      <form id="topUpForm">
        <input type="hidden" id="walletId" value="{{ unit.wallet.id if unit and unit.wallet else '' }}">

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Unit Information
          </label>
          <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm">
            <div class="flex justify-between mb-1">
              <span class="text-gray-600 dark:text-gray-400">Unit:</span>
              <span class="font-medium text-gray-900 dark:text-white">{{ unit.unit_number if unit else '—' }}</span>
            </div>
            <div class="flex justify-between mb-1">
              <span class="text-gray-600 dark:text-gray-400">Estate:</span>
              <span class="font-medium text-gray-900 dark:text-white">{{ estate.name if estate else '—' }}</span>
            </div>
            <div class="flex justify-between mb-1">
              <span class="text-gray-600 dark:text-gray-400">Current Balance:</span>
              <span class="font-medium text-gray-900 dark:text-white">R {{ (balance_value or 0) | format_number(2) }}</span>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <label for="topUpAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Top Up Amount (R) <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="topUpAmount"
            step="0.01"
            min="1"
            required
            placeholder="Enter amount"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"
          >
        </div>

        <div class="mb-4">
          <label for="topUpUtilityType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Utility Type <span class="text-red-500">*</span>
          </label>
          <select
            id="topUpUtilityType"
            required
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"
          >
            <option value="">Select utility type</option>
            {% if meter and meter.meter_type == 'electricity' %}
              <option value="electricity" selected>Electricity</option>
            {% elif meter and meter.meter_type == 'water' %}
              <option value="water" selected>Water</option>
            {% elif meter and meter.meter_type == 'solar' %}
              <option value="solar" selected>Solar</option>
            {% elif meter and meter.meter_type == 'hot_water' %}
              <option value="hot_water" selected>Hot Water</option>
            {% else %}
              <option value="electricity">Electricity</option>
              <option value="water">Water</option>
              <option value="solar">Solar</option>
              <option value="hot_water">Hot Water</option>
            {% endif %}
          </select>
        </div>

        <div class="mb-4">
          <label for="topUpReference" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Reference / Notes
          </label>
          <input
            type="text"
            id="topUpReference"
            placeholder="Optional reference or notes"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"
          >
        </div>

        <div class="flex justify-end space-x-3 mt-6">
          <button
            type="button"
            id="cancelTopUpBtn"
            class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
          >
            Cancel
          </button>
          <button
            type="submit"
            id="submitTopUpBtn"
            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600"
          >
            <i class="fas fa-check mr-2"></i>Confirm Top Up
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
<script>
  // Make meter_id and meter_type available to JavaScript
  window.METER_ID = "{{ meter_id }}";
  window.METER_TYPE = "{{ meter.meter_type if meter else 'unknown' }}";
</script>
<script src="/static/js/meters/meter-details.js"></script>
{% endblock %}
