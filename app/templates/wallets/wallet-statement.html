{% extends "base.html" %} {% block title %}Wallet Statement - {{
unit.unit_number }} - Quantify Metering System{% endblock %} {% block page_title
%}Prepaid Wallet Statement{% endblock %} {% block breadcrumb %}
<a href="{{ url_for('api_v1.dashboard') }}" class="hover:text-primary">Home</a>
<span class="mx-1">/</span>
<a href="{{ url_for('api_v1.units_page') }}" class="hover:text-primary"
  >Units</a
>
<span class="mx-1">/</span>
<a
  href="{{ url_for('api_v1.unit_details_page', unit_id=unit.id) }}"
  class="hover:text-primary"
  >{{ unit.unit_number }}</a
>
<span class="mx-1">/</span>
<span>Wallet Statement</span>
{% endblock %} {% block content %}
<!-- Statement Content -->
<div class="max-w-6xl mx-auto">
  <!-- Wallet Summary Card -->
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-lg mb-6 overflow-hidden"
  >
    <div class="bg-gradient-to-r from-primary to-blue-600 text-white p-6">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold mb-2">Current Wallet Balance</h2>
          <p class="text-4xl font-bold">
            R {{ wallet.balance | format_number(2) }}
          </p>
          <p class="text-sm opacity-90 mt-2">
            {% if last_topup_date %} Last top-up: {{
            last_topup_date.strftime('%b %d, %Y') }} {% else %} No top-ups yet
            {% endif %}
          </p>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div
      class="grid grid-cols-4 divide-x divide-gray-200 dark:divide-gray-700 p-4 bg-gray-50 dark:bg-gray-700/50"
    >
      <div class="px-4 text-center">
        <p class="text-xs text-gray-600 dark:text-gray-400">
          Electricity (kWh)
        </p>
        <p class="text-lg font-bold text-gray-900 dark:text-white">
          {{ electricity_kwh | format_number(2) }}
        </p>
      </div>
      <div class="px-4 text-center">
        <p class="text-xs text-gray-600 dark:text-gray-400">Water (kL)</p>
        <p class="text-lg font-bold text-gray-900 dark:text-white">
          {{ water_kl | format_number(2) }}
        </p>
      </div>
      <div class="px-4 text-center">
        <p class="text-xs text-gray-600 dark:text-gray-400">Hot Water (kWh)</p>
        <p class="text-lg font-bold text-gray-900 dark:text-white">
          {{ hot_water_kwh | format_number(2) }}
        </p>
      </div>
      <div class="px-4 text-center">
        <p class="text-xs text-gray-600 dark:text-gray-400">Solar (kWh)</p>
        <p class="text-lg font-bold text-gray-900 dark:text-white">
          {{ solar_kwh | format_number(2) }}
        </p>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <select
        id="statementPeriod"
        onchange="changeStatementPeriod(this.value)"
        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
      >
        <option value="current" {% if period=='current' or not period %}selected{% endif %}>Current Month</option>
        <option value="last" {% if period=='last' %}selected{% endif %}>Last Month</option>
        <option value="custom" {% if period=='custom' %}selected{% endif %}>Custom Period</option>
      </select>
      <div id="customPeriodControls" class="flex items-center gap-2 {% if period!='custom' %}hidden{% endif %}">
        <input id="startDate" type="date" value="{{ start_date or '' }}" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm" />
        <span class="text-gray-600 dark:text-gray-400 text-sm">to</span>
        <input id="endDate" type="date" value="{{ end_date or '' }}" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm" />
        <button onclick="applyCustomPeriod()" class="px-3 py-2 bg-primary hover:bg-blue-700 text-white rounded text-sm flex items-center gap-2">
          <i class="fas fa-filter"></i>
          Apply Filters
        </button>
        <button onclick="clearCustomPeriod()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded text-sm hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2">
          <i class="fas fa-times"></i>
          Clear Filters
        </button>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button
        onclick="printStatement()"
        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm"
      >
        <i class="fas fa-print mr-2"></i>Print
      </button>
      <button
        onclick="downloadStatement()"
        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 text-sm"
      >
        <i class="fas fa-download mr-2"></i>Download PDF
      </button>
    </div>
  </div>

  <!-- Consumption Breakdown removed (using simple summaries instead) -->

  <!-- Detailed Transaction Statement -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Transaction Details
      </h3>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead
          class="bg-gray-50 dark:bg-gray-700 text-xs uppercase text-gray-700 dark:text-gray-300"
        >
          <tr>
            <th class="px-4 py-3 text-left">Date & Time</th>
            <th class="px-4 py-3 text-left">Description</th>
            <th class="px-4 py-3 text-center">Usage</th>
            <th class="px-4 py-3 text-center">Method</th>
            <th class="px-4 py-3 text-right">Debit</th>
            <th class="px-4 py-3 text-right">Credit</th>
            <th class="px-4 py-3 text-right">Balance</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
          {% if transactions %} {% for txn in transactions %}
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">
              {{ txn.completed_at.strftime('%b %d, %H:%M') if txn.completed_at
              else 'Pending' }}
            </td>
            <td class="px-4 py-3">
              <span class="text-gray-900 dark:text-gray-300">
                {{ txn.description or txn.transaction_type.replace('_', '
                ').title() }}
              </span>
              {% if txn.reference %}
              <span class="text-xs text-gray-500 block"
                >{{ txn.reference }}</span
              >
              {% endif %}
            </td>
            <td class="px-4 py-3 text-center text-gray-700 dark:text-gray-300">
              -
            </td>
            <td
              class="px-4 py-3 text-center text-xs text-gray-700 dark:text-gray-300"
            >
              {{ txn.payment_method or '-' }}
            </td>
            {% if txn.transaction_type == 'topup' %}
            <td class="px-4 py-3 text-right text-gray-700 dark:text-gray-300">
              -
            </td>
            <td class="px-4 py-3 text-right text-green-600 font-semibold">
              R {{ txn.amount | format_number(2) }}
            </td>
            {% else %}
            <td class="px-4 py-3 text-right text-red-600">
              R {{ txn.amount | format_number(2) }}
            </td>
            <td class="px-4 py-3 text-right text-gray-700 dark:text-gray-300">
              -
            </td>
            {% endif %}
            <td
              class="px-4 py-3 text-right font-semibold text-gray-900 dark:text-white"
            >
              {% set balance_display = wallet.balance %} R {{ wallet.balance |
              format_number(2) }}
            </td>
          </tr>
          {% endfor %} {% else %}
          <tr>
            <td
              colspan="7"
              class="px-4 py-3 text-center text-gray-500 dark:text-gray-400"
            >
              No transactions this month
            </td>
          </tr>
          {% endif %}
        </tbody>
        <tfoot class="bg-gray-100 dark:bg-gray-700 font-semibold">
          <tr>
            <td colspan="4" class="px-4 py-3 text-gray-900 dark:text-gray-300">
              Current Balance as of {{ current_date.strftime('%b %d, %Y') }}
            </td>
            <td class="px-4 py-3 text-right text-red-600">-</td>
            <td class="px-4 py-3 text-right text-green-600">-</td>
            <td class="px-4 py-3 text-right text-lg text-primary">
              R {{ wallet.balance | format_number(2) }}
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    {% if transactions_pagination and (transactions_pagination.pages or 0) > 1
    %}
    <!-- Pagination controls -->
    <div
      class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between"
    >
      <div class="text-sm text-gray-700 dark:text-gray-300">
        Showing
        <span class="font-medium"
          >{{ ((transactions_pagination.page - 1) *
          transactions_pagination.per_page + 1) if transactions_pagination.total
          > 0 else 0 }}</span
        >
        to
        <span class="font-medium"
          >{{ (transactions_pagination.page * transactions_pagination.per_page)
          if (transactions_pagination.page * transactions_pagination.per_page) <
          transactions_pagination.total else transactions_pagination.total
          }}</span
        >
        of
        <span class="font-medium">{{ transactions_pagination.total }}</span>
        results
      </div>
      <div class="flex items-center gap-2">
        <a
          href="?page={{ transactions_pagination.page - 1 }}&per_page={{ transactions_pagination.per_page }}"
          class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not transactions_pagination.prev_page }}"
        >
          <i class="fas fa-chevron-left"></i>
        </a>
        <span class="px-3 py-1 bg-primary text-white rounded-lg"
          >{{ transactions_pagination.page }}</span
        >
        <a
          href="?page={{ transactions_pagination.page + 1 }}&per_page={{ transactions_pagination.per_page }}"
          class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not transactions_pagination.next_page }}"
        >
          <i class="fas fa-chevron-right"></i>
        </a>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Consumption Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-6">
    <!-- Electricity Summary -->
    <div
      class="bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-lg p-6 border border-yellow-200 dark:border-yellow-700"
    >
      <h4 class="font-semibold text-gray-900 dark:text-white mb-3">
        <i class="fas fa-bolt text-yellow-500 mr-2"></i>Electricity
      </h4>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600 dark:text-gray-400">Total (kWh):</span>
          <span class="font-semibold text-gray-900 dark:text-white"
            >{{ electricity_kwh | format_number(2) }}</span
          >
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600 dark:text-gray-400">Daily avg (kWh):</span>
          <span class="font-semibold text-gray-900 dark:text-white"
            >{{ electricity_kwh_daily | format_number(2) }}</span
          >
        </div>
      </div>
    </div>

    <!-- Water Summary -->
    <div
      class="bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 rounded-lg p-6 border border-blue-200 dark:border-blue-700"
    >
      <h4 class="font-semibold text-gray-900 dark:text-white mb-3">
        <i class="fas fa-tint text-blue-500 mr-2"></i>Water
      </h4>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600 dark:text-gray-400">Total (kL):</span>
          <span class="font-semibold text-gray-900 dark:text-white"
            >{{ water_kl | format_number(2) }}</span
          >
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600 dark:text-gray-400">Daily avg (kL):</span>
          <span class="font-semibold text-gray-900 dark:text-white"
            >{{ water_kl_daily | format_number(2) }}</span
          >
        </div>
      </div>
    </div>

    <!-- Hot Water Summary -->
    <div
      class="bg-gradient-to-br from-red-50 to-rose-50 dark:from-red-900/20 dark:to-rose-900/20 rounded-lg p-6 border border-red-200 dark:border-red-700"
    >
      <h4 class="font-semibold text-gray-900 dark:text-white mb-3">
        <i class="fas fa-hot-tub text-rose-500 mr-2"></i>Hot Water
      </h4>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600 dark:text-gray-400">Total (kWh):</span>
          <span class="font-semibold text-gray-900 dark:text-white"
            >{{ hot_water_kwh | format_number(2) }}</span
          >
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600 dark:text-gray-400">Daily avg (kWh):</span>
          <span class="font-semibold text-gray-900 dark:text-white"
            >{{ hot_water_kwh_daily | format_number(2) }}</span
          >
        </div>
      </div>
    </div>

    <!-- Solar Summary -->
    <div
      class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-lg p-6 border border-green-200 dark:border-green-700"
    >
      <h4 class="font-semibold text-gray-900 dark:text-white mb-3">
        <i class="fas fa-solar-panel text-green-500 mr-2"></i>Solar
      </h4>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600 dark:text-gray-400">Total (kWh):</span>
          <span class="font-semibold text-gray-900 dark:text-white"
            >{{ solar_kwh | format_number(2) }}</span
          >
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600 dark:text-gray-400">Daily avg (kWh):</span>
          <span class="font-semibold text-gray-900 dark:text-white"
            >{{ solar_kwh_daily | format_number(2) }}</span
          >
        </div>
      </div>
    </div>
  </div>

  <!-- Footer Notes -->
  <div
    class="mt-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg text-xs text-gray-600 dark:text-gray-400"
  >
    <p class="mb-2"><strong>Important Notes:</strong></p>
    <ul class="list-disc list-inside space-y-1">
      <li>
        Electricity supply will be automatically disconnected when wallet
        reaches R0.00
      </li>
      <li>
        Water supply continues but accumulates debt when wallet is depleted (for
        health and safety)
      </li>
      <li>
        Solar credits are applied automatically and shown as free consumption
      </li>
      <li>All rates include 15% VAT and 20% markup where applicable</li>
      <li>For top-ups, use the mobile app or visit the estate office</li>
    </ul>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Draw usage trend chart
  function drawUsageTrendChart() {
    const canvas = document.getElementById("usageTrendChart");
    if (canvas && canvas.getContext) {
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw axes
      ctx.strokeStyle = "#e5e7eb";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(30, 170);
      ctx.lineTo(380, 170);
      ctx.moveTo(30, 10);
      ctx.lineTo(30, 170);
      ctx.stroke();

      // Draw trend line
      ctx.strokeStyle = "#3b82f6";
      ctx.lineWidth = 2;
      ctx.beginPath();

      const data = [700, 668, 636, 604, 572, 540, 508, 476, 450, 418];
      const days = ["1", "2", "3", "4", "5", "6", "7", "8", "9 (Today)", "10"];

      data.forEach((value, index) => {
        const x = 30 + index * 35;
        const y = 170 - (value / 700) * 150;

        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }

        // Draw points
        ctx.fillStyle = index === 8 ? "#10b981" : "#3b82f6";
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fill();

        // Draw labels
        ctx.fillStyle = "#666";
        ctx.font = "9px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(days[index], x, 185);

        // Draw values
        if (index % 2 === 0) {
          ctx.fillText("R" + value, x, y - 10);
        }
      });

      ctx.stroke();

      // Draw projection
      ctx.strokeStyle = "#ef4444";
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.moveTo(30 + 8 * 35, 170 - (450 / 700) * 150);
      ctx.lineTo(380, 170);
      ctx.stroke();
      ctx.setLineDash([]);

      // Legend
      ctx.font = "10px sans-serif";
      ctx.fillStyle = "#3b82f6";
      ctx.fillText("â— Actual", 320, 20);
      ctx.fillStyle = "#ef4444";
      ctx.fillText("--- Projected", 320, 35);
    }
  }

  // Functions
  function changeStatementPeriod(period) {
    const controls = document.getElementById("customPeriodControls");
    if (period === "custom") {
      controls.classList.remove("hidden");
    } else {
      controls.classList.add("hidden");
      const url = new URL(window.location.href);
      url.searchParams.set("period", period);
      url.searchParams.delete("start_date");
      url.searchParams.delete("end_date");
      window.location.href = url.toString();
    }
  }

  function applyCustomPeriod() {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    if (!start || !end) {
      if (typeof showFlashMessage === 'function') {
        showFlashMessage("Please select start and end dates", "error", true);
      } else {
        alert("Please select start and end dates");
      }
      return;
    }
    const url = new URL(window.location.href);
    url.searchParams.set("period", "custom");
    url.searchParams.set("start_date", start);
    url.searchParams.set("end_date", end);
    window.location.href = url.toString();
  }

  function clearCustomPeriod() {
    const baseUrl = "{{ url_for('api_v1.wallet_statement_page', unit_id=unit.id) }}";
    window.location.href = baseUrl;
  }

  function printStatement() {
    window.print();
  }

  function downloadStatement() {
    const url = "{{ url_for('api_v1.wallet_statement_pdf', unit_id=unit.id) }}";
    window.location.href = url;
  }

  // Initialize
  window.addEventListener("load", () => {
    drawUsageTrendChart();
  });
</script>
{% endblock %}
