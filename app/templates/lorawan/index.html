{% extends "base.html" %}

{% block title %}LoRaWAN Management - Quantify Metering System{% endblock %}

{% block page_title %}LoRaWAN Management{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('api_v1.dashboard') }}" class="hover:text-primary">Dashboard</a>
<span class="mx-2">/</span>
<span class="text-gray-500 dark:text-gray-400">LoRaWAN</span>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Connection Status -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">ChirpStack Connection</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400">LoRaWAN Network Server Status</p>
            </div>
            <div id="connectionStatus" class="flex items-center gap-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">
                    <i class="fas fa-circle-notch fa-spin mr-2"></i> Checking...
                </span>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Gateways Card -->
        <a href="{{ url_for('api_v1.lorawan_gateways_page') }}" class="block bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Gateways</p>
                    <p id="gatewayCount" class="text-3xl font-bold text-gray-900 dark:text-white mt-1">--</p>
                </div>
                <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-full">
                    <i class="fas fa-broadcast-tower text-2xl text-green-600 dark:text-green-400"></i>
                </div>
            </div>
            <p class="text-sm text-primary mt-3">Manage Gateways <i class="fas fa-arrow-right ml-1"></i></p>
        </a>

        <!-- Devices Card -->
        <a href="{{ url_for('api_v1.lorawan_devices_page') }}" class="block bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Devices</p>
                    <p id="deviceCount" class="text-3xl font-bold text-gray-900 dark:text-white mt-1">--</p>
                </div>
                <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                    <i class="fas fa-microchip text-2xl text-blue-600 dark:text-blue-400"></i>
                </div>
            </div>
            <p class="text-sm text-primary mt-3">Manage Devices <i class="fas fa-arrow-right ml-1"></i></p>
        </a>

        <!-- Applications Card -->
        <a href="{{ url_for('api_v1.lorawan_applications_page') }}" class="block bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Applications</p>
                    <p id="applicationCount" class="text-3xl font-bold text-gray-900 dark:text-white mt-1">--</p>
                </div>
                <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-full">
                    <i class="fas fa-layer-group text-2xl text-purple-600 dark:text-purple-400"></i>
                </div>
            </div>
            <p class="text-sm text-primary mt-3">Manage Applications <i class="fas fa-arrow-right ml-1"></i></p>
        </a>
    </div>

    <!-- Recent Activity / Help -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Quick Actions -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quick Actions</h3>
            <div class="space-y-3">
                <a href="{{ url_for('api_v1.lorawan_devices_page') }}?action=add" class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg mr-3">
                        <i class="fas fa-plus text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">Add New Device</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Register a LoRaWAN meter or sensor</p>
                    </div>
                </a>
                <a href="{{ url_for('api_v1.lorawan_gateways_page') }}?action=add" class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg mr-3">
                        <i class="fas fa-plus text-green-600 dark:text-green-400"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">Add New Gateway</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Register a LoRaWAN gateway</p>
                    </div>
                </a>
                <a href="{{ url_for('api_v1.lorawan_applications_page') }}?action=add" class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <div class="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg mr-3">
                        <i class="fas fa-plus text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">Add New Application</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Create a device group</p>
                    </div>
                </a>
            </div>
        </div>

        <!-- Help Info -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">About LoRaWAN</h3>
            <div class="space-y-3 text-sm text-gray-600 dark:text-gray-400">
                <p>
                    <strong class="text-gray-900 dark:text-white">Gateways</strong> receive radio signals from devices and forward them to the network server. You need at least one gateway per location.
                </p>
                <p>
                    <strong class="text-gray-900 dark:text-white">Devices</strong> are your meters and sensors. Each device needs a unique DevEUI and must be registered before it can connect.
                </p>
                <p>
                    <strong class="text-gray-900 dark:text-white">Device Profiles</strong> define the device capabilities (LoRaWAN version, class, codec). These are pre-configured in ChirpStack.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Test connection
    fetch('/api/v1/api/lorawan/test-connection')
        .then(response => response.json())
        .then(data => {
            const statusEl = document.getElementById('connectionStatus');
            if (data.success) {
                statusEl.innerHTML = `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">
                        <i class="fas fa-check-circle mr-2"></i> Connected
                    </span>
                `;
            } else {
                statusEl.innerHTML = `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400">
                        <i class="fas fa-times-circle mr-2"></i> ${data.message || 'Disconnected'}
                    </span>
                `;
            }
        })
        .catch(error => {
            document.getElementById('connectionStatus').innerHTML = `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400">
                    <i class="fas fa-times-circle mr-2"></i> Error
                </span>
            `;
        });

    // Load counts
    Promise.all([
        fetch('/api/v1/api/lorawan/gateways').then(r => r.json()),
        fetch('/api/v1/api/lorawan/devices').then(r => r.json()),
        fetch('/api/v1/api/lorawan/applications').then(r => r.json())
    ]).then(([gateways, devices, applications]) => {
        document.getElementById('gatewayCount').textContent = gateways.gateways?.length || 0;
        document.getElementById('deviceCount').textContent = devices.devices?.length || 0;
        document.getElementById('applicationCount').textContent = applications.applications?.length || 0;
    }).catch(error => {
        console.error('Error loading counts:', error);
    });
});
</script>
{% endblock %}
