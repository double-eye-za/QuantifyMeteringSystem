{% extends "base.html" %} {% block title %}Dashboard - Quantify Metering
System{% endblock %} {% block head_resources %} {% endblock %} {% block
page_title %}System Overview{% endblock %} {% block breadcrumb %}
<a href="{{ url_for('api_v1.index') }}" class="hover:text-primary">Home</a>
{% endblock %} {% block content %}

<!-- Top bar: Estate selector and Date range selector -->
<div class="flex items-center gap-4 mb-6">
  <div class="flex items-center gap-4">
    <label
      for="estateFilter"
      class="text-sm font-medium text-gray-700 dark:text-gray-300"
    >
      Estate Filter
    </label>
    <select
      id="estateFilter"
      class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white"
    >
      <option value="all">All Estates</option>
      {% for estate in estates %}
      <option value="{{ estate.id }}">{{ estate.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="flex items-center gap-4">
    <label
      for="dateRange"
      class="text-sm font-medium text-gray-700 dark:text-gray-300"
    >
      Time Period
    </label>
    <select
      id="dateRange"
      class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white"
    >
      <option value="current-month">Current Month ({{ current_month }})</option>
      <option value="previous-month">Previous Month</option>
      <option value="past-3-months">Past 3 Months</option>
    </select>
  </div>
</div>

<!-- 1. Summary Metrics (KPI Cards) -->
<div
  class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-8 gap-4 mb-6"
>
  <!-- Total Electricity Consumption -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-8 h-8 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-bolt text-blue-500 text-sm"></i>
      </div>
      <span class="text-xs text-gray-500">{{ current_month }}</span>
    </div>
    <p class="text-xl font-bold text-gray-900 dark:text-white">
      {{ kpis.total_electricity_kwh | round(1) }} kWh
    </p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Total Electricity</p>
  </div>

  <!-- Total Water Consumption -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-8 h-8 bg-teal-100 dark:bg-teal-900/20 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-tint text-teal-500 text-sm"></i>
      </div>
      <span class="text-xs text-gray-500">{{ current_month }}</span>
    </div>
    <p class="text-xl font-bold text-gray-900 dark:text-white">
      {{ kpis.total_water_liters | round(0) }} L
    </p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Total Water</p>
  </div>

  <!-- Solar Contribution -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900/20 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-sun text-yellow-500 text-sm"></i>
      </div>
      <span class="text-xs text-gray-500">{{ current_month }}</span>
    </div>
    <p class="text-xl font-bold text-gray-900 dark:text-white">
      {{ kpis.solar_contribution_kwh | round(1) }} kWh
    </p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Solar Contribution</p>
  </div>

  <!-- Revenue Collected -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-8 h-8 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-money-bill-wave text-green-500 text-sm"></i>
      </div>
      <span class="text-xs text-gray-500">{{ current_month }}</span>
    </div>
    <p class="text-xl font-bold text-gray-900 dark:text-white">
      R {{ kpis.revenue_collected | round(0) }}
    </p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Revenue Collected</p>
  </div>

  <!-- Active Units -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-8 h-8 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-house text-green-500 text-sm"></i>
      </div>
      <span class="text-xs text-green-600">Live</span>
    </div>
    <p class="text-xl font-bold text-gray-900 dark:text-white">
      {{ kpis.active_units }}
    </p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Active Units</p>
  </div>

  <!-- Offline / Faulty Meters -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-8 h-8 bg-red-100 dark:bg-red-900/20 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-exclamation-triangle text-red-500 text-sm"></i>
      </div>
      <span class="text-xs text-red-600">Alert</span>
    </div>
    <p class="text-xl font-bold text-gray-900 dark:text-white">
      {{ kpis.offline_meters }}
    </p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Offline Meters</p>
  </div>

  <!-- Total Disconnections -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-8 h-8 bg-red-100 dark:bg-red-900/20 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-power-off text-red-500 text-sm"></i>
      </div>
      <span class="text-xs text-red-600">Critical</span>
    </div>
    <p class="text-xl font-bold text-gray-900 dark:text-white">
      {{ kpis.disconnected_units }}
    </p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Disconnected</p>
  </div>

  <!-- Communal Area Usage -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div
        class="w-8 h-8 bg-gray-100 dark:bg-gray-900/20 rounded-lg flex items-center justify-center"
      >
        <i class="fas fa-building text-gray-500 text-sm"></i>
      </div>
      <span class="text-xs text-gray-500">{{ current_month }}</span>
    </div>
    <p class="text-xl font-bold text-gray-900 dark:text-white">
      {{ kpis.communal_electricity | round(1) }} kWh
    </p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Communal Usage</p>
  </div>
</div>

<!-- 3. Alerts & Notifications Panel -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
  <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
    <i class="fas fa-bell text-yellow-500 mr-2"></i>Real-time Alerts &
    Notifications
  </h3>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <!-- Offline Meters -->
    <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4">
      <div class="flex items-center mb-2">
        <i class="fas fa-wifi text-red-500 mr-2"></i>
        <span class="font-semibold text-red-800 dark:text-red-200"
          >Offline Meters</span
        >
      </div>
      {% if offline_meters_alert %} {% for meter in offline_meters_alert %}
      <p class="text-sm text-red-700 dark:text-red-300">
        {{ meter.serial_number }} - {{ meter.meter_type }}
      </p>
      {% endfor %} {% else %}
      <p class="text-sm text-green-700 dark:text-green-300">
        All meters online
      </p>
      {% endif %}
    </div>

    <!-- Low Credit Alerts -->
    <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4">
      <div class="flex items-center mb-2">
        <i class="fas fa-exclamation text-yellow-500 mr-2"></i>
        <span class="font-semibold text-yellow-800 dark:text-yellow-200"
          >Low Credit Alerts</span
        >
      </div>
      {% if low_credit_alerts %} {% for wallet, unit, estate in
      low_credit_alerts %}
      <p class="text-sm text-yellow-700 dark:text-yellow-300">
        {{ unit.unit_number }} ({{ estate.name }}) - R{{ wallet.balance |
        round(2) }}
      </p>
      {% endfor %} {% else %}
      <p class="text-sm text-green-700 dark:text-green-300">
        No low balance alerts
      </p>
      {% endif %}
    </div>

    <!-- Tamper/Fault Warnings -->
    <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4">
      <div class="flex items-center mb-2">
        <i class="fas fa-shield-alt text-orange-500 mr-2"></i>
        <span class="font-semibold text-orange-800 dark:text-orange-200"
          >Tamper/Fault Warnings</span
        >
      </div>
      {% if tamper_alerts %} {% for alert in tamper_alerts %}
      <p class="text-sm text-orange-700 dark:text-orange-300">
        {{ alert.alert_type }} - {{ alert.message }}
      </p>
      {% endfor %} {% else %}
      <p class="text-sm text-green-700 dark:text-green-300">No tamper alerts</p>
      {% endif %}
    </div>

    <!-- Failed Top-ups -->
    <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4">
      <div class="flex items-center mb-2">
        <i class="fas fa-credit-card text-red-500 mr-2"></i>
        <span class="font-semibold text-red-800 dark:text-red-200"
          >Failed Top-ups</span
        >
      </div>
      {% if failed_topups %} {% for txn in failed_topups %}
      <p class="text-sm text-red-700 dark:text-red-300">
        {{ txn.transaction_number }} - R{{ txn.amount | round(2) }}
      </p>
      {% endfor %} {% else %}
      <p class="text-sm text-green-700 dark:text-green-300">
        No failed transactions
      </p>
      {% endif %}
    </div>
  </div>
</div>

<!-- 4. Estate Overview Widgets -->
<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6 mb-6">
  <!-- Live Status Summary -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      <i class="fas fa-signal text-green-500 mr-2"></i>Live Status Summary
    </h3>
    <div class="space-y-3">
      <div class="flex items-center justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">Online</span>
        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full"
          >{{ live_status.online }}</span
        >
      </div>
      <div class="flex items-center justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">Low Signal</span>
        <span
          class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full"
          >{{ live_status.low_signal }}</span
        >
      </div>
      <div class="flex items-center justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">Offline</span>
        <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full"
          >{{ live_status.offline }}</span
        >
      </div>
    </div>
  </div>

  <!-- Bulk Meter Feed Status -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      <i class="fas fa-broadcast-tower text-blue-500 mr-2"></i>Bulk Meter Feed
      Status
    </h3>
    <div class="space-y-3">
      {% for status in bulk_meter_status %}
      <div
        class="border-b border-gray-200 dark:border-gray-700 pb-2 last:border-b-0"
      >
        <div class="font-medium text-sm text-gray-900 dark:text-white">
          {{ status.name }}
        </div>
        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
          <div class="flex items-center justify-between">
            <span>Elec Meter</span>
            <span
              class="{% if status.last_elec_reading %}text-green-600{% else %}text-red-600{% endif %}"
            >
              {% if status.last_elec_reading %} {{
              status.last_elec_reading.strftime('%b %d, %H:%M') }} {% else %} No
              readings {% endif %}
            </span>
          </div>
          <div class="flex items-center justify-between">
            <span>Water Meter</span>
            <span
              class="{% if status.last_water_reading %}text-green-600{% else %}text-red-600{% endif %}"
            >
              {% if status.last_water_reading %} {{
              status.last_water_reading.strftime('%b %d, %H:%M') }} {% else %}
              No readings {% endif %}
            </span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Solar Offset Gauge -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      <i class="fas fa-sun text-yellow-500 mr-2"></i>Solar Offset Gauge
    </h3>
    <div class="text-center">
      <div class="text-3xl font-bold text-yellow-600">
        {{ solar_offset_percentage | round(1) }}%
      </div>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        of total electricity supplied via solar
      </p>
    </div>
  </div>

  <!-- Communal Usage Gauge -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
      <i class="fas fa-building text-gray-500 mr-2"></i>Communal Usage Gauge
    </h3>
    <div class="text-center">
      <div class="text-3xl font-bold text-gray-600">
        {{ communal_usage_percentage | round(1) }}%
      </div>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        of bulk usage for common areas
      </p>
    </div>
  </div>
</div>

<!-- 5. Financial Snapshot -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
  <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
    <i class="fas fa-chart-line text-green-500 mr-2"></i>Financial Snapshot
  </h3>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Left Column: Stats -->
    <div class="space-y-6">
      <!-- Total Top-Ups -->
      <div class="text-center bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
        <div class="text-2xl font-bold text-green-600">
          R {{ todays_topups | round(0) }}
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400">Today's Top-ups</p>
      </div>

      <!-- Communal Area Cost Estimate -->
      <div class="text-center bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
        <div class="text-2xl font-bold text-gray-600">
          R {{ communal_cost_estimate | round(0) }}
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400">
          Communal Area Cost Estimate
        </p>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          Based on tariff rates: Elec R2.50/kWh, Water R15.00/kL
        </p>
      </div>
    </div>

    <!-- Right Column: Visual Components -->
    <div class="space-y-6">
      <!-- Revenue per Utility (Bar Graph) -->
      <div>
        <h4 class="font-semibold text-gray-900 dark:text-white mb-3">
          Revenue per Utility - {{ current_month }}
        </h4>
        {% if revenue_per_utility %}
        <div class="space-y-2">
          {% for utility in revenue_per_utility %}
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div
                class="w-3 h-3 rounded-full {% if utility.utility == 'Electricity' %}bg-blue-500{% elif utility.utility == 'Water' %}bg-teal-500{% elif utility.utility == 'Solar' %}bg-yellow-500{% else %}bg-gray-500{% endif %}"
              ></div>
              <span class="text-sm font-medium">{{ utility.utility }}</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-32 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                {% set max_revenue = revenue_per_utility |
                map(attribute='revenue') | max %}
                <div
                  class="h-2 rounded-full {% if utility.utility == 'Electricity' %}bg-blue-500{% elif utility.utility == 'Water' %}bg-teal-500{% elif utility.utility == 'Solar' %}bg-yellow-500{% else %}bg-gray-500{% endif %}"
                  style="width: {{ (utility.revenue / max_revenue * 100) if max_revenue > 0 else 0 }}%"
                ></div>
              </div>
              <span class="text-sm font-semibold text-gray-900 dark:text-white"
                >R {{ utility.revenue | round(0) }}</span
              >
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div
          class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4"
        >
          <div class="flex items-center">
            <i
              class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 mr-2"
            ></i>
            <span class="text-sm text-yellow-800 dark:text-yellow-200"
              >No revenue data available for the selected period</span
            >
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Top Paying Units -->
      <div>
        <h4 class="font-semibold text-gray-900 dark:text-white mb-3">
          Top Paying Units - {{ current_month }}
        </h4>
        {% if top_paying_units %}
        <div class="space-y-2">
          {% for unit in top_paying_units %}
          <div
            class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center"
              >
                <span class="text-xs font-bold text-primary"
                  >{{ loop.index }}</span
                >
              </div>
              <div>
                <div class="font-medium text-sm text-gray-900 dark:text-white">
                  {{ unit.unit_number }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  {{ unit.estate_name }}
                </div>
              </div>
            </div>
            <div class="text-right">
              <div class="font-semibold text-sm text-gray-900 dark:text-white">
                R {{ unit.total_spent | round(0) }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                Total spent
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div
          class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4"
        >
          <div class="flex items-center">
            <i
              class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 mr-2"
            ></i>
            <span class="text-sm text-yellow-800 dark:text-yellow-200"
              >No payment data available for the selected period</span
            >
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  // Auto-refresh every 5 minutes
  setInterval(() => {
    location.reload();
  }, 300000); // 5 minutes

  // Add hover tooltips functionality
  document.addEventListener("DOMContentLoaded", function () {
    // Add tooltip functionality to KPI cards
    const kpiCards = document.querySelectorAll(
      ".bg-white.dark\\:bg-gray-800.rounded-lg.shadow-sm.p-4"
    );
    kpiCards.forEach((card) => {
      card.addEventListener("mouseenter", function () {
        this.style.transform = "translateY(-2px)";
        this.style.transition = "transform 0.2s ease";
      });
      card.addEventListener("mouseleave", function () {
        this.style.transform = "translateY(0)";
      });
    });

    // Handle filter changes
    const estateFilter = document.getElementById("estateFilter");
    const dateRange = document.getElementById("dateRange");

    function updateDashboard() {
      const estateId = estateFilter.value;
      const timePeriod = dateRange.value;

      // Build URL with parameters
      const url = new URL(window.location);
      url.searchParams.set("estate", estateId);
      url.searchParams.set("period", timePeriod);

      // Reload page with new parameters
      window.location.href = url.toString();
    }

    // Add event listeners
    estateFilter.addEventListener("change", updateDashboard);
    dateRange.addEventListener("change", updateDashboard);

    // Set initial values from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const estateParam = urlParams.get("estate");
    const periodParam = urlParams.get("period");

    if (estateParam) {
      estateFilter.value = estateParam;
    }
    if (periodParam) {
      dateRange.value = periodParam;
    }
  });
</script>
{% endblock %}
