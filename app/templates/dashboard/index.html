{% extends "base.html" %} {% block title %}Dashboard - Quantify Metering
System{% endblock %} {% block head_resources %} {% endblock %} {% block
page_title %}System Overview{% endblock %} {% block breadcrumb %}
<a href="{{ url_for('api_v1.index') }}" class="hover:text-primary">Home</a>
{% endblock %} {% block content %}

<!-- Top bar: Estate selector, Time Range, and Utility Type filters -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 mb-6">
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
    <div class="flex flex-wrap items-center gap-4 flex-1">
      <!-- Estate Selector -->
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Estate</label>
    <select
      id="estateFilter"
          class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-primary"
    >
          <option value="all" {% if estate_filter == "all" %}selected{% endif %}>All Estates</option>
      {% for estate in estates %}
          <option value="{{ estate.id }}" {% if estate_filter == estate.id|string %}selected{% endif %}>{{ estate.name }}</option>
      {% endfor %}
    </select>
  </div>

      <!-- Time Range Selector -->
      <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Time Range</label>
    <select
      id="dateRange"
          class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-primary"
        >
          <option value="current-month" {% if period == "current-month" %}selected{% endif %}>Current Month ({{ current_month }})</option>
          <option value="previous-month" {% if period == "previous-month" %}selected{% endif %}>Previous Month</option>
          <option value="past-3-months" {% if period == "past-3-months" %}selected{% endif %}>Past 3 Months</option>
        </select>
      </div>

      
    </div>
    <div class="ml-auto flex items-center gap-2">
      <button type="button" onclick="applyFilters()" class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg text-sm transition-colors">
        <i class="fas fa-filter mr-2"></i> Apply Filters
      </button>
      <button type="button" onclick="resetFilters()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg text-sm transition-colors">
        <i class="fas fa-times mr-2"></i> Reset Filters
      </button>
    </div>
  </div>
</div>

<!-- 1. KPI Summary Bar (Top Row) -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
  <!-- Electricity Used (kWh) -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center">
        <i class="fas fa-bolt text-blue-500 text-lg"></i>
      </div>
      <span class="text-xs text-gray-500">{{ current_month }}</span>
    </div>
    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ kpis.electricity_used_kwh | format_number(1) }} kWh</p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Electricity Used</p>
  </div>

  <!-- Cold Water Used (kL) -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="w-10 h-10 bg-cyan-100 dark:bg-cyan-900/20 rounded-lg flex items-center justify-center">
        <i class="fas fa-tint text-cyan-500 text-lg"></i>
      </div>
      <span class="text-xs text-gray-500">{{ current_month }}</span>
    </div>
    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ kpis.cold_water_kL | format_number(1) }} kL</p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Cold Water Used</p>
  </div>

  <!-- Hot Water Used (kL) -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="w-10 h-10 bg-orange-100 dark:bg-orange-900/20 rounded-lg flex items-center justify-center">
        <i class="fas fa-thermometer-half text-orange-500 text-lg"></i>
      </div>
      <span class="text-xs text-gray-500">{{ current_month }}</span>
    </div>
    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ kpis.hot_water_kL | format_number(1) }} kL</p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Hot Water Used</p>
  </div>

  <!-- Solar Consumption (kWh) -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900/20 rounded-lg flex items-center justify-center">
        <i class="fas fa-sun text-yellow-500 text-lg"></i>
      </div>
      <span class="text-xs text-gray-500">{{ current_month }}</span>
    </div>
    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ kpis.solar_kwh | format_number(1) }} kWh</p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Solar Consumption</p>
    <p class="text-xs text-green-600 font-medium mt-1">{{ kpis.solar_contribution_percent | format_number(1) }}% contribution</p>
  </div>

  <!-- Total Revenue (R) -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="w-10 h-10 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center">
        <i class="fas fa-money-bill-wave text-green-500 text-lg"></i>
      </div>
      <span class="text-xs text-gray-500">{{ current_month }}</span>
    </div>
    <p class="text-2xl font-bold text-gray-900 dark:text-white">R {{ kpis.total_revenue | format_number(0) }}</p>
    <p class="text-xs text-gray-600 dark:text-gray-400">Total Revenue</p>
  </div>
</div>

<!-- Two-Column Grid Layout -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <!-- Left Column: Usage Charts -->
  <div class="space-y-6">
    <!-- A) Estate Usage Comparison Chart -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          <i class="fas fa-chart-bar text-primary mr-2"></i>Estate Usage Comparison
  </h3>
      </div>
      <div id="estateComparisonChart" class="h-64 flex items-center justify-center text-gray-500">
        <canvas id="estateChart"></canvas>
      </div>
    </div>

    <!-- B) Current Monthly Consumption Trend -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          <i class="fas fa-chart-line text-primary mr-2"></i>Monthly Consumption Trend
    </h3>
      </div>
      <div id="consumptionTrendChart" class="h-64 flex items-center justify-center text-gray-500">
        <canvas id="trendChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Right Column: Alerts & Financial Snapshot -->
  <div class="space-y-6">
    <!-- Real-Time Notifications & Alerts -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          <i class="fas fa-bell text-yellow-500 mr-2"></i>Real-Time Alerts
    </h3>
        <a href="{{ url_for('api_v1.list_notifications') }}" class="text-sm text-primary hover:underline">View All</a>
      </div>

      <div class="space-y-3 max-h-96 overflow-y-auto">
        {% if alerts %}
          {% for alert in alerts[:5] %}
          <div class="border-l-4 {% if alert.severity == 'critical' %}border-red-500{% elif alert.severity == 'warning' %}border-yellow-500{% else %}border-blue-500{% endif %} bg-{% if alert.severity == 'critical' %}red{% elif alert.severity == 'warning' %}yellow{% else %}blue{% endif %}-50 dark:bg-{% if alert.severity == 'critical' %}red{% elif alert.severity == 'warning' %}yellow{% else %}blue{% endif %}-900/20 rounded p-3">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  {% if alert.alert_type == 'system' %}
                    <i class="fas fa-server text-gray-500 text-sm"></i>
                  {% elif alert.alert_type == 'resident' %}
                    <i class="fas fa-home text-gray-500 text-sm"></i>
                  {% endif %}
                  <span class="text-sm font-medium text-gray-900 dark:text-white">{{ alert.title }}</span>
        </div>
                <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">{{ alert.estate_name or 'N/A' }} / {{ alert.unit_number or 'N/A' }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-500">{{ alert.timestamp.strftime('%b %d, %Y %H:%M') if alert.timestamp else 'Unknown' }}</p>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i class="fas fa-check-circle text-4xl mb-2 text-green-500"></i>
            <p>No active alerts</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Financial Snapshot -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
        <i class="fas fa-chart-pie text-primary mr-2"></i>Financial Snapshot
      </h3>
      
      <!-- Revenue by Utility Type -->
      <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Revenue by Utility Type</h4>
        {% if revenue_by_utility %}
        <div class="relative">
          <canvas id="revenueChart" class="max-h-64"></canvas>
              </div>
        <div class="mt-4 grid grid-cols-2 gap-2">
          {% for utility in revenue_by_utility %}
          <div class="flex items-center gap-2 text-sm">
            <div class="w-3 h-3 rounded-full 
              {% if utility.utility == 'Electricity' %}bg-blue-500
              {% elif utility.utility == 'Water' %}bg-cyan-500
              {% elif utility.utility == 'Solar' %}bg-yellow-500
              {% else %}bg-gray-500{% endif %}"></div>
            <span class="text-gray-600 dark:text-gray-400">{{ utility.utility }}</span>
            <span class="font-semibold text-gray-900 dark:text-white">R{{ utility.revenue | format_number(0) }}</span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4 text-gray-500">No revenue data available</div>
        {% endif %}
      </div>

      <!-- Average Spend per Resident -->
      <div>
        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Average Spend per Resident</h4>
        <div class="text-center bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
          <div class="text-3xl font-bold text-green-600">R{{ avg_spend_per_resident | format_number(0) }}</div>
          <p class="text-xs text-gray-600 dark:text-gray-400">Current Month Average</p>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  

  function applyFilters() {
    const estate = document.getElementById('estateFilter').value;
    const period = document.getElementById('dateRange').value;
    
    const url = new URL(window.location);
    url.searchParams.set('estate', estate);
    url.searchParams.set('period', period);
    
    window.location.href = url.toString();
  }

  // Revenue Pie Chart
  {% if revenue_by_utility %}
  const revenueData = {{ revenue_by_utility | tojson }};
  const revenueCtx = document.getElementById('revenueChart');
  if (revenueCtx) {
    const revenueLabels = revenueData.map(u => u.utility);
    const revenueValues = revenueData.map(u => u.revenue);
    const revenueColors = revenueLabels.map(label => {
      if (label === 'Electricity') return 'rgb(59, 130, 246)';
      if (label === 'Water') return 'rgb(6, 182, 212)';
      if (label === 'Hot Water') return 'rgb(249, 115, 22)';
      if (label === 'Solar') return 'rgb(234, 179, 8)';
      return 'rgb(107, 114, 128)';
    });

    new Chart(revenueCtx, {
      type: 'pie',
      data: {
        labels: revenueLabels,
        datasets: [{
          data: revenueValues,
          backgroundColor: revenueColors,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false }
        }
      }
    });
  }
  {% endif %}

  // Estate Usage Comparison Chart
  {% if estate_usage_data %}
  const estateData = {{ estate_usage_data | tojson }};
  const estateCtx = document.getElementById('estateChart');
  if (estateCtx) {
    new Chart(estateCtx, {
      type: 'bar',
      data: {
        labels: estateData.map(e => e.name),
        datasets: [
          {
            label: 'Electricity (kWh)',
            data: estateData.map(e => e.electricity),
            backgroundColor: 'rgb(59, 130, 246)',
          },
          {
            label: 'Water (kL)',
            data: estateData.map(e => e.water),
            backgroundColor: 'rgb(6, 182, 212)',
          },
          {
            label: 'Hot Water (kL)',
            data: estateData.map(e => e.hot_water || 0),
            backgroundColor: 'rgb(249, 115, 22)',
          },
          {
            label: 'Solar (kWh)',
            data: estateData.map(e => e.solar),
            backgroundColor: 'rgb(234, 179, 8)',
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
  {% endif %}

  // Monthly Consumption Trend Chart
  {% if daily_consumption_data %}
  const dailyData = {{ daily_consumption_data | tojson }};
  const trendCtx = document.getElementById('trendChart');
  if (trendCtx) {
    new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: dailyData.map(d => d.date),
        datasets: [
          {
            label: 'Electricity (kWh)',
            data: dailyData.map(d => d.electricity),
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4
          },
          {
            label: 'Water (kL)',
            data: dailyData.map(d => d.water),
            borderColor: 'rgb(6, 182, 212)',
            backgroundColor: 'rgba(6, 182, 212, 0.1)',
            tension: 0.4
          },
          {
            label: 'Hot Water (kL)',
            data: dailyData.map(d => d.hot_water || 0),
            borderColor: 'rgb(249, 115, 22)',
            backgroundColor: 'rgba(249, 115, 22, 0.1)',
            tension: 0.4
          },
          {
            label: 'Solar (kWh)',
            data: dailyData.map(d => d.solar),
            borderColor: 'rgb(234, 179, 8)',
            backgroundColor: 'rgba(234, 179, 8, 0.1)',
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
  {% endif %}

  function resetFilters() {
    window.location.href = '/api/v1/dashboard';
  }

  
  setTimeout(() => {
    location.reload();
  }, 60000);
</script>
{% endblock %}
