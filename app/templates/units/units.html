{% extends "base.html" %} {% block title %}Unit Management - Quantify Metering
System{% endblock %} {% block page_title %}Unit Management{% endblock %} {%
block breadcrumb %}
<a href="{{ url_for('api_v1.dashboard') }}" class="hover:text-primary">Home</a>
                                <span class="mx-1">/</span>
<a href="{{ url_for('api_v1.estates_page') }}" class="hover:text-primary"
  >Estates</a
>
                                <span class="mx-1">/</span>
                                <span>Units</span>
{% endblock %} {% block content %}
                
<div class="flex justify-end mb-4">
  {% if has_permission('units.create') %}
  <button
    onclick="showAddUnitModal()"
    class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg text-sm transition-colors"
    type="button"
  >
    <i class="fas fa-plus mr-2"></i> Add Unit
  </button>
  {% endif %}
</div>

                <!-- Filters Bar -->
<div
  class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 mb-6"
>
  <div id="unitFilters">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">

      <div class="flex-1 max-w-md">
                            <div class="relative">
          <input
            id="searchInput"
            name="q"
            value="{{ current_filters.q or '' }}"
            type="text"
            placeholder="Search unit, estate, tenant..."
            class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-primary"
          />
                                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 dark:text-gray-500"></i>
                            </div>
      </div>


      <div class="flex items-center gap-3">

        <select
          id="estateFilter"
          name="estate_id"
          class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm text-gray-700 dark:text-gray-300"
        >
          <option value="">All Estates</option>
          {% for e in estates %}
          <option value="{{ e.id }}" {% if current_filters.estate_id==e.id %}selected{% endif %}>{{ e.name }}</option>
          {% endfor %}
        </select>

                            <!-- Status Filter -->
        <select
          id="statusFilter"
          name="occupancy_status"
          class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-primary"
        >
          <option value="">All Status</option>
          <option value="occupied" {% if current_filters.occupancy_status=='occupied' %}selected{% endif %}>Occupied</option>
          <option value="vacant" {% if current_filters.occupancy_status=='vacant' %}selected{% endif %}>Vacant</option>
                            </select>

        <button
          type="button"
          id="clearFiltersBtn"
          class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg text-sm transition-colors"
        >
          <i class="fas fa-times mr-2"></i> Clear
                            </button>
                        </div>
                    </div>
  </div>
                </div>

                <!-- Units Table -->
<div
  class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden"
>
                    <div class="overflow-x-auto">
                        <table class="w-full">
      <thead
        class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600"
      >
                                <tr>
                                    <th class="px-4 py-3 text-left">
            <input
              type="checkbox"
              class="rounded border-gray-300 dark:border-gray-600"
            />
                                    </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Unit
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Estate
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Tenants
          </th>
          <th
            class="px-4 py-3 text-center text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Electricity
          </th>
          <th
            class="px-4 py-3 text-center text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Water
          </th>
          <th
            class="px-4 py-3 text-center text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Hot Water
          </th>
          <th
            class="px-4 py-3 text-center text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Solar
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Status
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Actions
          </th>
                                </tr>
                            </thead>
                            <tbody id="unitsTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
       {% set current_estate_id = namespace(value=None) %}
       {% set estate_name_ns = namespace(value='') %}
       {% for u in units %}
        {# Insert estate header row when estate changes #}
        {% if u.estate_id != current_estate_id.value %}
          {% set current_estate_id.value = u.estate_id %}
          {% set estate_name_ns.value = '' %}
          {% for e in estates %}
            {% if e.id == u.estate_id %}
              {% set estate_name_ns.value = e.name %}
            {% endif %}
          {% endfor %}
          {% set estate_unit_count = estate_unit_counts.get(u.estate_id, 0) %}
        <tr class="estate-header-row bg-gradient-to-r from-blue-600 to-blue-500 dark:from-blue-700 dark:to-blue-600">
          <td colspan="10" class="px-4 py-2">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <i class="fas fa-building text-white/80"></i>
                <span class="text-sm font-semibold text-white">{{ estate_name_ns.value }}</span>
              </div>
              <span class="text-xs text-white/80 bg-white/20 px-2 py-0.5 rounded-full">{{ estate_unit_count }} unit{{ 's' if estate_unit_count != 1 else '' }}</span>
            </div>
          </td>
        </tr>
        {% endif %}
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors" data-unit='{{ u | tojson }}'>
          <td class="px-4 py-3"><input type="checkbox" class="rounded border-gray-300 dark:border-gray-600"/></td>
                                    <td class="px-4 py-3">
                                        <div>
              <a href="{{ url_for('api_v1.unit_details_page', unit_id=u.id) }}" class="text-sm font-medium text-primary hover:text-blue-700 hover:underline cursor-pointer">Unit {{ u.unit_number }}</a>
              <p class="text-xs text-gray-500 dark:text-gray-400">{{ u.floor or '' }}</p>
                                        </div>
                                    </td>
          <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-300">{% for e in estates %}{% if e.id==u.estate_id %}{{ e.name }}{% endif %}{% endfor %}</td>
                                    <td class="px-4 py-3">
                                        <div>
              {% if u.tenants %}
                {% for tenant in u.tenants %}
                  <p class="text-sm text-gray-900 dark:text-white">{{ tenant.first_name ~ ' ' ~ tenant.last_name }}</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">{{ tenant.phone }}</p>
                  {% if not loop.last %}<div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>{% endif %}
                {% endfor %}
              {% elif u.occupancy_status != 'vacant' %}
                <p class="text-sm text-gray-500 dark:text-gray-400">No tenant assigned</p>
              {% else %}
                <p class="text-sm text-gray-500 dark:text-gray-400">Vacant</p>
              {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex flex-col items-center">
              <span class="text-xs font-mono text-gray-600 dark:text-gray-400">{{ u.electricity_meter_id or '—' }}</span>
              {% if u.occupancy_status=='vacant' %}
                                            <span class="text-xs font-semibold text-gray-500">-</span>
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 mt-1">
                <i class="fas fa-pause-circle mr-1" style="font-size: 8px"></i>
                                                Inactive
                                            </span>
              {% else %}
              {% set bal = (u.wallet.balance if u.wallet else 0)|float %}
              {% set low_threshold = (u.wallet.low_balance_threshold if u.wallet and u.wallet.low_balance_threshold else 50)|float %}
              <span class="text-xs font-semibold {{ 'text-red-600 dark:text-red-400' if bal <= 0 else ('text-yellow-600 dark:text-yellow-400' if bal < low_threshold else 'text-gray-900 dark:text-white') }}">R {{ bal | format_number(2) }}</span>
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs mt-1 {{ 'bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-400' if bal <= 0 else ('bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-400' if bal < low_threshold else 'bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400') }}">
                <i class="fas {{ 'fa-times-circle' if bal <= 0 else ('fa-exclamation-triangle' if bal < low_threshold else 'fa-circle') }} mr-1" style="font-size: 8px"></i>
                {{ 'Disconnected' if bal <= 0 else ('Low' if bal < low_threshold else 'Active') }}
              </span>
              {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex flex-col items-center">
              <span class="text-xs font-mono text-gray-600 dark:text-gray-400">{{ u.water_meter_id or '—' }}</span>
              {% if u.occupancy_status=='vacant' %}
                                            <span class="text-xs font-semibold text-gray-500">-</span>
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 mt-1">
                <i class="fas fa-pause-circle mr-1" style="font-size: 8px"></i>
                                                Inactive
                                            </span>
              {% else %}
              {% set bal = (u.wallet.balance if u.wallet else 0)|float %}
              {% set low_threshold = (u.wallet.low_balance_threshold if u.wallet and u.wallet.low_balance_threshold else 50)|float %}
              <span class="text-xs font-semibold {{ 'text-red-600 dark:text-red-400' if bal <= 0 else ('text-yellow-600 dark:text-yellow-400' if bal < low_threshold else 'text-gray-900 dark:text-white') }}">R {{ bal | format_number(2) }}</span>
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs mt-1 {{ 'bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-400' if bal <= 0 else ('bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-400' if bal < low_threshold else 'bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400') }}">
                <i class="fas {{ 'fa-times-circle' if bal <= 0 else ('fa-exclamation-triangle' if bal < low_threshold else 'fa-circle') }} mr-1" style="font-size: 8px"></i>
                {{ 'Disconnected' if bal <= 0 else ('Low' if bal < low_threshold else 'Active') }}
              </span>
              {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex flex-col items-center">
              <span class="text-xs font-mono text-gray-600 dark:text-gray-400">{{ u.hot_water_meter_id or '—' }}</span>
              {% if u.occupancy_status=='vacant' %}
                                            <span class="text-xs font-semibold text-gray-500">-</span>
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 mt-1">
                <i class="fas fa-pause-circle mr-1" style="font-size: 8px"></i>
                                                Inactive
                                            </span>
              {% else %}
              {% set bal = (u.wallet.balance if u.wallet else 0)|float %}
              {% set low_threshold = (u.wallet.low_balance_threshold if u.wallet and u.wallet.low_balance_threshold else 50)|float %}
              <span class="text-xs font-semibold {{ 'text-red-600 dark:text-red-400' if bal <= 0 else ('text-yellow-600 dark:text-yellow-400' if bal < low_threshold else 'text-gray-900 dark:text-white') }}">R {{ bal | format_number(2) }}</span>
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs mt-1 {{ 'bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-400' if bal <= 0 else ('bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-400' if bal < low_threshold else 'bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400') }}">
                <i class="fas {{ 'fa-times-circle' if bal <= 0 else ('fa-exclamation-triangle' if bal < low_threshold else 'fa-circle') }} mr-1" style="font-size: 8px"></i>
                {{ 'Disconnected' if bal <= 0 else ('Low' if bal < low_threshold else 'Active') }}
              </span>
              {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex flex-col items-center">
              <span class="text-xs font-mono text-gray-600 dark:text-gray-400">{{ u.solar_meter_id or '—' }}</span>
              {% if u.occupancy_status=='vacant' %}
                                            <span class="text-xs font-semibold text-gray-500">-</span>
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 mt-1">
                <i class="fas fa-pause-circle mr-1" style="font-size: 8px"></i>
                                                Inactive
                                            </span>
              {% else %}
              {% set bal = (u.wallet.balance if u.wallet else 0)|float %}
              {% set low_threshold = (u.wallet.low_balance_threshold if u.wallet and u.wallet.low_balance_threshold else 50)|float %}
              <span class="text-xs font-semibold {{ 'text-red-600 dark:text-red-400' if bal <= 0 else ('text-yellow-600 dark:text-yellow-400' if bal < low_threshold else 'text-gray-900 dark:text-white') }}">R {{ bal | format_number(2) }}</span>
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs mt-1 {{ 'bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-400' if bal <= 0 else ('bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-400' if bal < low_threshold else 'bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400') }}">
                <i class="fas {{ 'fa-times-circle' if bal <= 0 else ('fa-exclamation-triangle' if bal < low_threshold else 'fa-circle') }} mr-1" style="font-size: 8px"></i>
                {{ 'Disconnected' if bal <= 0 else ('Low' if bal < low_threshold else 'Active') }}
                                        </span>
              {% endif %}
                                        </div>
                                    </td>
          <td class="px-4 py-3">
            {% if u.is_active == false %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-400">Decommissioned</span>
            {% elif u.occupancy_status=='occupied' %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400">Occupied</span>
            {% else %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">{{ u.occupancy_status|capitalize if u.occupancy_status else 'Vacant' }}</span>
            {% endif %}
          </td>
                                    <td class="px-4 py-3">
                                        <div class="flex items-center gap-2">
              <a href="{{ url_for('api_v1.unit_details_page', unit_id=u.id) }}" class="text-primary hover:underline text-sm"><i class="fas fa-eye mr-1"></i>View</a>
              {% if u.is_active != false %}
                {# Active units: show normal actions #}
                {% if u.occupancy_status=='vacant' %}
                  <button type="button" onclick="assignResident()" class="text-green-600 dark:text-green-400 hover:underline text-sm">Assign</button>
                {% else %}
                  {% if has_permission('units.edit') %}
                  <button type="button" onclick="editUnit(this)" class="text-gray-600 dark:text-gray-400 hover:text-primary text-sm"><i class="fas fa-edit mr-1"></i>Edit</button>
                  {% endif %}
                {% endif %}
                {% if has_permission('units.delete') %}
                <button type="button" onclick="confirmDecommissionUnit({{ u.id }}, '{{ u.unit_number }}')" class="text-yellow-600 dark:text-yellow-400 hover:underline text-sm"><i class="fas fa-archive mr-1"></i>Decommission</button>
                {% endif %}
              {% else %}
                {# Decommissioned units: show Recommission and Delete buttons #}
                {% if has_permission('units.edit') %}
                <button type="button" onclick="confirmRecommissionUnit({{ u.id }}, '{{ u.unit_number }}')" class="text-green-600 dark:text-green-400 hover:underline text-sm"><i class="fas fa-undo mr-1"></i>Recommission</button>
                {% endif %}
                {% if has_permission('units.delete') %}
                <button type="button" onclick="confirmDeleteUnit({{ u.id }})" class="text-red-600 dark:text-red-400 hover:underline text-sm"><i class="fas fa-trash mr-1"></i>Delete</button>
                {% endif %}
              {% endif %}
                                        </div>
                                    </td>
                                </tr>
       {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-700 dark:text-gray-300">
         Showing <span class="font-medium">{{ ((pagination.page-1)*pagination.per_page)+1 if pagination.total>0 else 0 }}</span>
         to <span class="font-medium">{{ (pagination.page*pagination.per_page) if (pagination.page*pagination.per_page) < pagination.total else pagination.total }}</span>
         of <span class="font-medium">{{ pagination.total }}</span> units
                            </div>
                            <div class="flex items-center gap-2">
         <a href="{{ url_for('api_v1.units_page', page=(pagination.prev_page or 1), per_page=pagination.per_page, estate_id=current_filters.estate_id, occupancy_status=current_filters.occupancy_status, q=current_filters.q) }}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not pagination.prev_page }}">
                                    <i class="fas fa-chevron-left"></i>
         </a>
         <span class="px-3 py-1 bg-primary text-white rounded-lg">{{ pagination.page }}</span>
         <a href="{{ url_for('api_v1.units_page', page=(pagination.next_page or pagination.page), per_page=pagination.per_page, estate_id=current_filters.estate_id, occupancy_status=current_filters.occupancy_status, q=current_filters.q) }}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not pagination.next_page }}">
                                    <i class="fas fa-chevron-right"></i>
         </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
<div
  class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 mt-6"
>
  <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
    Meter Status Legend:
  </p>
                    <div class="flex flex-wrap gap-4 text-xs">
                        <div class="flex items-center gap-1">
      <i class="fas fa-circle text-green-500" style="font-size: 8px"></i>
      <span class="text-gray-600 dark:text-gray-400"
        >Active - Service connected</span
      >
                        </div>
                        <div class="flex items-center gap-1">
      <i
        class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400"
        style="font-size: 8px"
      ></i>
      <span class="text-gray-600 dark:text-gray-400"
        >Low - Credit below threshold</span
      >
                        </div>
                        <div class="flex items-center gap-1">
      <i
        class="fas fa-times-circle text-red-600 dark:text-red-400"
        style="font-size: 8px"
      ></i>
      <span class="text-gray-600 dark:text-gray-400"
        >Disconnected - No credit</span
      >
                        </div>
                        <div class="flex items-center gap-1">
      <i
        class="fas fa-faucet text-yellow-600 dark:text-yellow-400"
        style="font-size: 8px"
      ></i>
      <span class="text-gray-600 dark:text-gray-400"
        >Low Warning - Low credit warning</span
      >
                        </div>
                        <div class="flex items-center gap-1">
      <i class="fas fa-pause-circle text-gray-500" style="font-size: 8px"></i>
      <span class="text-gray-600 dark:text-gray-400"
        >Inactive - Unit vacant</span
      >
                        </div>
        </div>
    </div>


<!-- Delete Unit Confirmation Modal -->
<div id="deleteUnitModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Delete Unit</h3>
    </div>
    <div class="p-4 text-sm text-gray-700 dark:text-gray-300">Are you sure you want to delete this unit? This action cannot be undone.</div>
    <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
      <button type="button" onclick="hideDeleteUnitModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg">Cancel</button>
      <button type="button" onclick="performDeleteUnit()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Delete</button>
    </div>
  </div>
</div>

<!-- Decommission Unit Confirmation Modal -->
<div id="decommissionUnitModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white"><i class="fas fa-archive mr-2 text-yellow-500"></i>Decommission Unit</h3>
    </div>
    <div class="p-4 text-sm text-gray-700 dark:text-gray-300">
      <p class="mb-3">Are you sure you want to decommission unit <strong id="decommissionUnitLabel"></strong>?</p>
      <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3">
        <p class="text-yellow-800 dark:text-yellow-300 text-sm"><i class="fas fa-info-circle mr-2"></i>This will:</p>
        <ul class="list-disc list-inside text-yellow-700 dark:text-yellow-400 text-sm mt-2 space-y-1">
          <li>Mark the unit as inactive</li>
          <li>Unlink all meters (they can be reassigned)</li>
          <li>Preserve wallet and transaction history</li>
        </ul>
      </div>
    </div>
    <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
      <button type="button" onclick="hideDecommissionUnitModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg">Cancel</button>
      <button type="button" onclick="performDecommissionUnit()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg"><i class="fas fa-archive mr-2"></i>Decommission</button>
    </div>
  </div>
</div>

<!-- Recommission Unit Confirmation Modal -->
<div id="recommissionUnitModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white"><i class="fas fa-undo mr-2 text-green-500"></i>Recommission Unit</h3>
    </div>
    <div class="p-4 text-sm text-gray-700 dark:text-gray-300">
      <p class="mb-3">Are you sure you want to recommission unit <strong id="recommissionUnitLabel"></strong>?</p>
      <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
        <p class="text-green-800 dark:text-green-300 text-sm"><i class="fas fa-info-circle mr-2"></i>This will:</p>
        <ul class="list-disc list-inside text-green-700 dark:text-green-400 text-sm mt-2 space-y-1">
          <li>Mark the unit as active again</li>
          <li>Set status to vacant (ready for new tenant)</li>
          <li>Meters will need to be reassigned</li>
        </ul>
      </div>
    </div>
    <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
      <button type="button" onclick="hideRecommissionUnitModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg">Cancel</button>
      <button type="button" onclick="performRecommissionUnit()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg"><i class="fas fa-undo mr-2"></i>Recommission</button>
    </div>
  </div>
</div>

<!-- Add Unit Modal (prototype structure) -->
<div
  id="addUnitModal"
  class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
  >
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Add New Unit
      </h3>
            </div>
            <div class="p-6">
                <form class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
                                Unit Number <span class="text-red-600 dark:text-red-400">*</span>
                            </label>
            <input
                name="unit_number"
              type="text"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary"
              placeholder="e.g., A-101"
            />
                        </div>
                        <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
                                Estate <span class="text-red-600 dark:text-red-400">*</span>
                            </label>
              <select
                name="estate_id"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
            >
              {% for e in estates %}
                <option value="{{ e.id }}">{{ e.name }}</option>
              {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div>
          <h4
            class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3"
          >
            Meter Assignment (optional)
          </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                                    <i class="fas fa-bolt text-yellow-500 mr-1"></i>
                Electricity Meter (E460)
                                </label>
              <select name="electricity_meter_id" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select electricity meter</option>
                {% for m in electricity_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
                            </div>
                            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                                    <i class="fas fa-tint text-blue-500 mr-1"></i>
                Water Meter
                                </label>
              <select name="water_meter_id" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select water meter</option>
                {% for m in water_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
                            </div>
                            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                                    <i class="fas fa-fire text-red-500 mr-1"></i>
                Hot Water Meter
                                </label>
              <select name="hot_water_meter_id" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select hot water meter</option>
                {% for m in hot_water_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
                            </div>
                            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                                    <i class="fas fa-solar-panel text-orange-500 mr-1"></i>
                Solar Meter (E460)
                                </label>
              <select name="solar_meter_id" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select solar meter</option>
                {% for m in solar_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
                            </div>
                        </div>
                    </div>

                    <div>
          <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
            People Assignment (optional)
          </h4>

          <!-- Added People List -->
          <div id="addedPeopleList" class="mb-4 space-y-2"></div>

          <!-- Add Person Form -->
          <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4 space-y-3">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Select Person
                </label>
                <select id="addPersonSelect" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                  <option value="">-- Select Person --</option>
                  {% for p in persons %}
                  <option value="{{ p.id }}">{{ p.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Role
                </label>
                <select id="addPersonRole" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                  <option value="tenant">Tenant</option>
                  <option value="owner">Owner</option>
                </select>
              </div>
            </div>
            <div>
              <button
                type="button"
                onclick="addPersonToUnit()"
                class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm transition-colors"
              >
                <i class="fas fa-plus mr-2"></i> Add Person
              </button>
            </div>
          </div>
        </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Size (sqm)</label>
            <input name="size_sqm" type="number" step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="e.g., 85.50" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Floor/Location</label>
            <input
              name="floor"
              type="text"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary"
              placeholder="e.g., Ground Floor"
            />
          </div>
        </div>
                </form>
            </div>
    <div
      class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3"
    >
      <button
        onclick="hideAddUnitModal()"
        class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors"
      >
                    Cancel
                </button>
      <button
        onclick="saveUnit()"
        class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg transition-colors"
      >
                    Add Unit
                </button>
            </div>
        </div>
    </div>

<!-- Edit Unit Modal (same structure) -->
<div id="editUnitModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Edit Unit
      </h3>
    </div>
    <div class="p-6">
      <form class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >Unit Number
              <span class="text-red-600 dark:text-red-400">*</span></label
            >
            <input
              id="edit_unit_number"
              type="text"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary"
              placeholder="e.g., A-101"
            />
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >Estate
              <span class="text-red-600 dark:text-red-400">*</span></label
            >
            <select id="edit_unit_estate" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
              {% for e in estates %}
                <option value="{{ e.id }}">{{ e.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div>
          <h4
            class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3"
          >
            Meter Assignment (optional)
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                ><i class="fas fa-bolt text-yellow-500 mr-1"></i>Electricity
                Meter (E460)</label
              >
              <select id="edit_unit_emeter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select electricity meter</option>
                {% for m in electricity_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                ><i class="fas fa-tint text-blue-500 mr-1"></i>Water Meter</label
              >
              <select id="edit_unit_wmeter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select water meter</option>
                {% for m in water_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                ><i class="fas fa-fire text-red-500 mr-1"></i>Hot Water Meter</label
              >
              <select id="edit_unit_hwmeter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select hot water meter</option>
                {% for m in hot_water_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                ><i class="fas fa-solar-panel text-orange-500 mr-1"></i>Solar
                Meter (E460)</label
              >
              <select id="edit_unit_smeter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select solar meter</option>
                {% for m in solar_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <!-- Tenant/Owner management is now done separately via Unit Details page -->
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Floor/Location</label
          >
          <input
            id="edit_unit_floor"
            type="text"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="e.g., Ground Floor"
          />
        </div>
      </form>
    </div>

    <div
      class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3"
    >
      <button
        onclick="hideEditUnitModal()"
        class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors"
      >
        Cancel
      </button>
      <button
        onclick="saveEditedUnit()"
        class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg transition-colors"
      >
        Save Changes
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="{{ url_for('static', filename='js/flash.js') }}"></script>
<script src="{{ url_for('static', filename='js/common/table-filters.js') }}"></script>
<script>
  // Pass permissions and estates to JavaScript for dynamic row rendering
  window.UNIT_PERMISSIONS = {
    canEdit: {{ 'true' if has_permission('units.edit') else 'false' }},
    canDelete: {{ 'true' if has_permission('units.delete') else 'false' }}
  };
  window.ESTATES_MAP = {
    {% for e in estates %}{{ e.id }}: "{{ e.name }}"{% if not loop.last %},{% endif %}{% endfor %}
  };
</script>
<script src="{{ url_for('static', filename='js/units/units.js') }}"></script>
{% endblock %}

