{% extends "base.html" %} {% block title %}Unit Management - Quantify Metering
System{% endblock %} {% block page_title %}Unit Management{% endblock %} {%
block breadcrumb %}
<a href="{{ url_for('api_v1.dashboard') }}" class="hover:text-primary">Home</a>
                                <span class="mx-1">/</span>
<a href="{{ url_for('api_v1.estates_page') }}" class="hover:text-primary"
  >Estates</a
>
                                <span class="mx-1">/</span>
                                <span>Units</span>
{% endblock %} {% block content %}
                
<div class="flex justify-end mb-4">
  {% if has_permission('units.create') %}
  <button
    onclick="showAddUnitModal()"
    class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg text-sm transition-colors"
    type="button"
  >
    <i class="fas fa-plus mr-2"></i> Add Unit
  </button>
  {% endif %}
</div>

                <!-- Filters Bar -->
<div
  class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 mb-6"
>
  <form id="unitFilters" method="get" action="{{ url_for('api_v1.units_page') }}">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      
      <div class="flex-1 max-w-md">
                            <div class="relative">
          <input 
            id="searchInput"
            name="q" 
            value="{{ current_filters.q or '' }}" 
            type="text" 
            placeholder="Search unit number..." 
            class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-primary" 
          />
                                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 dark:text-gray-500"></i>
                            </div>
      </div>

      
      <div class="flex items-center gap-3">
        
        <select 
          id="estateFilter"
          name="estate_id" 
          class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm text-gray-700 dark:text-gray-300"
        >
          <option value="">All Estates</option>
          {% for e in estates %}
          <option value="{{ e.id }}" {% if current_filters.estate_id==e.id %}selected{% endif %}>{{ e.name }}</option>
          {% endfor %}
        </select>

                            <!-- Status Filter -->
        <select 
          id="statusFilter"
          name="occupancy_status" 
          class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-primary"
        >
          <option value="">All Status</option>
          <option value="occupied" {% if current_filters.occupancy_status=='occupied' %}selected{% endif %}>Occupied</option>
          <option value="vacant" {% if current_filters.occupancy_status=='vacant' %}selected{% endif %}>Vacant</option>
                            </select>

        
        <button
          type="button"
          onclick="applyFilters()"
          class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg text-sm transition-colors"
        >
          <i class="fas fa-filter mr-2"></i> Apply Filters
        </button>
        
        <button
          type="button"
          onclick="clearFilters()"
          class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg text-sm transition-colors"
        >
          <i class="fas fa-times mr-2"></i> Clear Filters
                            </button>
                        </div>
                    </div>
  </form>
                </div>

                <!-- Units Table -->
<div
  class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden"
>
                    <div class="overflow-x-auto">
                        <table class="w-full">
      <thead
        class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600"
      >
                                <tr>
                                    <th class="px-4 py-3 text-left">
            <input
              type="checkbox"
              class="rounded border-gray-300 dark:border-gray-600"
            />
                                    </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Unit
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Estate
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Resident
          </th>
          <th
            class="px-4 py-3 text-center text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Electricity
          </th>
          <th
            class="px-4 py-3 text-center text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Water
          </th>
          <th
            class="px-4 py-3 text-center text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Solar
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Status
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider"
          >
            Actions
          </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
       {% for u in units %}
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors" data-unit='{{ u | tojson }}'>
          <td class="px-4 py-3"><input type="checkbox" class="rounded border-gray-300 dark:border-gray-600"/></td>
                                    <td class="px-4 py-3">
                                        <div>
              <a href="{{ url_for('api_v1.unit_details_page', unit_id=u.id) }}" class="text-sm font-medium text-primary hover:text-blue-700 hover:underline cursor-pointer">Unit {{ u.unit_number }}</a>
              <p class="text-xs text-gray-500 dark:text-gray-400">{{ u.floor or '' }}</p>
                                        </div>
                                    </td>
          <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-300">{% for e in estates %}{% if e.id==u.estate_id %}{{ e.name }}{% endif %}{% endfor %}</td>
                                    <td class="px-4 py-3">
                                        <div>
              <p class="text-sm text-gray-900 dark:text-white">{{ (u.resident.first_name ~ ' ' ~ u.resident.last_name) if (u.resident and u.occupancy_status!='vacant') else 'No resident' }}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">{{ (u.resident.phone) if (u.resident and u.occupancy_status!='vacant') else '' }}</p>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex flex-col items-center">
              <span class="text-xs font-mono text-gray-600 dark:text-gray-400">{{ u.electricity_meter_id or '—' }}</span>
              {% if u.occupancy_status=='vacant' %}
                                            <span class="text-xs font-semibold text-gray-500">-</span>
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 mt-1">
                <i class="fas fa-pause-circle mr-1" style="font-size: 8px"></i>
                                                Inactive
                                            </span>
              {% else %}
              {% set eb = (u.wallet.electricity_balance if u.wallet else 0) %}
              <span class="text-xs font-semibold {{ 'text-red-600 dark:text-red-400' if eb|float <= 0 else ('text-yellow-600 dark:text-yellow-400' if eb|float < 50 else 'text-gray-900 dark:text-white') }}">R {{ eb|float | format_number(2) }}</span>
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs mt-1 {{ 'bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-400' if eb|float <= 0 else ('bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-400' if eb|float < 50 else 'bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400') }}">
                <i class="fas {{ 'fa-times-circle' if eb|float <= 0 else ('fa-exclamation-triangle' if eb|float < 50 else 'fa-circle') }} mr-1" style="font-size: 8px"></i>
                {{ 'Disconnected' if eb|float <= 0 else ('Low' if eb|float < 50 else 'Active') }}
              </span>
              {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex flex-col items-center">
              <span class="text-xs font-mono text-gray-600 dark:text-gray-400">{{ u.water_meter_id or '—' }}</span>
              {% if u.occupancy_status=='vacant' %}
                                            <span class="text-xs font-semibold text-gray-500">-</span>
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 mt-1">
                <i class="fas fa-pause-circle mr-1" style="font-size: 8px"></i>
                                                Inactive
                                            </span>
              {% else %}
              {% set wb = (u.wallet.water_balance if u.wallet else 0) %}
              <span class="text-xs font-semibold {{ 'text-red-600 dark:text-red-400' if wb|float <= 0 else ('text-yellow-600 dark:text-yellow-400' if wb|float < 50 else 'text-gray-900 dark:text-white') }}">R {{ wb|float | format_number(2) }}</span>
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs mt-1 {{ 'bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-400' if wb|float <= 0 else ('bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-400' if wb|float < 50 else 'bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400') }}">
                <i class="fas {{ 'fa-times-circle' if wb|float <= 0 else ('fa-exclamation-triangle' if wb|float < 50 else 'fa-circle') }} mr-1" style="font-size: 8px"></i>
                {{ 'Disconnected' if wb|float <= 0 else ('Low' if wb|float < 50 else 'Active') }}
              </span>
              {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex flex-col items-center">
              <span class="text-xs font-mono text-gray-600 dark:text-gray-400">{{ u.solar_meter_id or '—' }}</span>
              {% if u.occupancy_status=='vacant' %}
                                            <span class="text-xs font-semibold text-gray-500">-</span>
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 mt-1">
                <i class="fas fa-pause-circle mr-1" style="font-size: 8px"></i>
                                                Inactive
                                            </span>
              {% else %}
              {% set sb = (u.wallet.solar_balance if u.wallet else 0) %}
              <span class="text-xs font-semibold {{ 'text-red-600 dark:text-red-400' if sb|float <= 0 else ('text-yellow-600 dark:text-yellow-400' if sb|float < 50 else 'text-gray-900 dark:text-white') }}">R {{ sb|float | format_number(2) }}</span>
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs mt-1 {{ 'bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-400' if sb|float <= 0 else ('bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-400' if sb|float < 50 else 'bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400') }}">
                <i class="fas {{ 'fa-times-circle' if sb|float <= 0 else ('fa-exclamation-triangle' if sb|float < 50 else 'fa-circle') }} mr-1" style="font-size: 8px"></i>
                {{ 'Disconnected' if sb|float <= 0 else ('Low' if sb|float < 50 else 'Active') }}
                                        </span>
              {% endif %}
                                        </div>
                                    </td>
          <td class="px-4 py-3"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ 'bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-400' if u.occupancy_status=='occupied' else 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400' }}">{{ u.occupancy_status|capitalize }}</span></td>
                                    <td class="px-4 py-3">
                                        <div class="flex items-center gap-2">
              <a href="{{ url_for('api_v1.unit_details_page', unit_id=u.id) }}" class="text-primary hover:underline text-sm"><i class="fas fa-eye mr-1"></i>View</a>
              {% if u.occupancy_status=='vacant' %}
                <button type="button" onclick="assignResident()" class="text-green-600 dark:text-green-400 hover:underline text-sm">Assign</button>
              {% else %}
                {% if has_permission('units.edit') %}
                <button type="button" onclick="editUnit(this)" class="text-gray-600 dark:text-gray-400 hover:text-primary text-sm"><i class="fas fa-edit mr-1"></i>Edit</button>
                {% endif %}
              {% endif %}
              {% if has_permission('units.delete') %}
              <button type="button" onclick="confirmDeleteUnit({{ u.id }})" class="text-red-600 dark:text-red-400 hover:underline text-sm"><i class="fas fa-trash mr-1"></i>Delete</button>
              {% endif %}
                                        </div>
                                    </td>
                                </tr>
       {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-700 dark:text-gray-300">
         Showing <span class="font-medium">{{ ((pagination.page-1)*pagination.per_page)+1 if pagination.total>0 else 0 }}</span>
         to <span class="font-medium">{{ (pagination.page*pagination.per_page) if (pagination.page*pagination.per_page) < pagination.total else pagination.total }}</span>
         of <span class="font-medium">{{ pagination.total }}</span> units
                            </div>
                            <div class="flex items-center gap-2">
         <a href="{{ url_for('api_v1.units_page', page=(pagination.prev_page or 1), per_page=pagination.per_page, estate_id=current_filters.estate_id, occupancy_status=current_filters.occupancy_status, q=current_filters.q) }}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not pagination.prev_page }}">
                                    <i class="fas fa-chevron-left"></i>
         </a>
         <span class="px-3 py-1 bg-primary text-white rounded-lg">{{ pagination.page }}</span>
         <a href="{{ url_for('api_v1.units_page', page=(pagination.next_page or pagination.page), per_page=pagination.per_page, estate_id=current_filters.estate_id, occupancy_status=current_filters.occupancy_status, q=current_filters.q) }}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not pagination.next_page }}">
                                    <i class="fas fa-chevron-right"></i>
         </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
<div
  class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 mt-6"
>
  <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
    Meter Status Legend:
  </p>
                    <div class="flex flex-wrap gap-4 text-xs">
                        <div class="flex items-center gap-1">
      <i class="fas fa-circle text-green-500" style="font-size: 8px"></i>
      <span class="text-gray-600 dark:text-gray-400"
        >Active - Service connected</span
      >
                        </div>
                        <div class="flex items-center gap-1">
      <i
        class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400"
        style="font-size: 8px"
      ></i>
      <span class="text-gray-600 dark:text-gray-400"
        >Low - Credit below R50</span
      >
                        </div>
                        <div class="flex items-center gap-1">
      <i
        class="fas fa-times-circle text-red-600 dark:text-red-400"
        style="font-size: 8px"
      ></i>
      <span class="text-gray-600 dark:text-gray-400"
        >Disconnected - No credit</span
      >
                        </div>
                        <div class="flex items-center gap-1">
      <i
        class="fas fa-faucet text-yellow-600 dark:text-yellow-400"
        style="font-size: 8px"
      ></i>
      <span class="text-gray-600 dark:text-gray-400"
        >Low Warning - Low credit warning</span
      >
                        </div>
                        <div class="flex items-center gap-1">
      <i class="fas fa-pause-circle text-gray-500" style="font-size: 8px"></i>
      <span class="text-gray-600 dark:text-gray-400"
        >Inactive - Unit vacant</span
      >
                        </div>
        </div>
    </div>


<!-- Delete Unit Confirmation Modal -->
<div id="deleteUnitModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Delete Unit</h3>
    </div>
    <div class="p-4 text-sm text-gray-700 dark:text-gray-300">Are you sure you want to delete this unit? This action cannot be undone.</div>
    <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
      <button type="button" onclick="hideDeleteUnitModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg">Cancel</button>
      <button type="button" onclick="performDeleteUnit()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Delete</button>
    </div>
  </div>
</div>

<!-- Add Unit Modal (prototype structure) -->
<div
  id="addUnitModal"
  class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
  >
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Add New Unit
      </h3>
            </div>
            <div class="p-6">
                <form class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
                                Unit Number <span class="text-red-600 dark:text-red-400">*</span>
                            </label>
            <input
                name="unit_number"
              type="text"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary"
              placeholder="e.g., A-101"
            />
                        </div>
                        <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
                                Estate <span class="text-red-600 dark:text-red-400">*</span>
                            </label>
              <select
                name="estate_id"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
            >
              {% for e in estates %}
                <option value="{{ e.id }}">{{ e.name }}</option>
              {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div>
          <h4
            class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3"
          >
            Meter Assignment (3 meters required per unit)
          </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                                    <i class="fas fa-bolt text-yellow-500 mr-1"></i>
                Electricity Meter (E460)
                <span class="text-red-600 dark:text-red-400">*</span>
                                </label>
              <select name="electricity_meter_id" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select electricity meter</option>
                {% for m in electricity_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
                            </div>
                            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                                    <i class="fas fa-tint text-blue-500 mr-1"></i>
                Water Meter
                <span class="text-red-600 dark:text-red-400">*</span>
                                </label>
              <select name="water_meter_id" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select water meter</option>
                {% for m in water_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
                            </div>
                            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                                    <i class="fas fa-solar-panel text-orange-500 mr-1"></i>
                Solar Meter (E460)
                <span class="text-red-600 dark:text-red-400">*</span>
                                </label>
              <select name="solar_meter_id" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select solar meter</option>
                {% for m in solar_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Resident</label>
            <select name="resident_id" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
              <option value="">Unassigned</option>
              {% for r in residents %}
                <option value="{{ r.id }}">{{ r.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Size (sqm)</label>
            <input name="size_sqm" type="number" step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="e.g., 85.50" />
          </div>
        </div>
                    <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Floor/Location</label>
          <input
            name="floor"
            type="text"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="e.g., Ground Floor"
          />
                    </div>
                </form>
            </div>
    <div
      class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3"
    >
      <button
        onclick="hideAddUnitModal()"
        class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors"
      >
                    Cancel
                </button>
      <button
        onclick="saveUnit()"
        class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg transition-colors"
      >
                    Add Unit
                </button>
            </div>
        </div>
    </div>

<!-- Edit Unit Modal (same structure) -->
<div id="editUnitModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Edit Unit
      </h3>
    </div>
    <div class="p-6">
      <form class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >Unit Number
              <span class="text-red-600 dark:text-red-400">*</span></label
            >
            <input
              id="edit_unit_number"
              type="text"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary"
              placeholder="e.g., A-101"
            />
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >Estate
              <span class="text-red-600 dark:text-red-400">*</span></label
            >
            <select id="edit_unit_estate" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
              {% for e in estates %}
                <option value="{{ e.id }}">{{ e.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div>
          <h4
            class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3"
          >
            Meter Assignment (3 meters required per unit)
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                ><i class="fas fa-bolt text-yellow-500 mr-1"></i>Electricity
                Meter (E460)
                <span class="text-red-600 dark:text-red-400">*</span></label
              >
              <select id="edit_unit_emeter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select electricity meter</option>
                {% for m in electricity_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                ><i class="fas fa-tint text-blue-500 mr-1"></i>Water Meter
                <span class="text-red-600 dark:text-red-400">*</span></label
              >
              <select id="edit_unit_wmeter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select water meter</option>
                {% for m in water_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                ><i class="fas fa-solar-panel text-orange-500 mr-1"></i>Solar
                Meter (E460)
                <span class="text-red-600 dark:text-red-400">*</span></label
              >
              <select id="edit_unit_smeter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select solar meter</option>
                {% for m in solar_meters %}
                  <option value="{{ m.id }}" {% if m.disabled %}disabled{% endif %}>{{ m.serial_number }}{% if m.disabled %} (assigned){% endif %}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Resident</label>
          <select id="edit_unit_resident" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
            <option value="">Unassigned</option>
            {% for r in residents %}
              <option value="{{ r.id }}">{{ r.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Floor/Location</label
          >
          <input
            id="edit_unit_floor"
            type="text"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="e.g., Ground Floor"
          />
        </div>
      </form>
    </div>

    <div
      class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3"
    >
      <button
        onclick="hideEditUnitModal()"
        class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors"
      >
        Cancel
      </button>
      <button
        onclick="saveEditedUnit()"
        class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg transition-colors"
      >
        Save Changes
      </button>
    </div>
  </div>
</div>
<!-- Add Unit Modal -->
<div
  id="addUnitModal"
  class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-xl w-full max-h-[90vh] overflow-y-auto"
  >
    <div
      class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between"
    >
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Add New Unit
      </h3>
      <button
        onclick="hideAddUnitModal()"
        class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
      >
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form onsubmit="event.preventDefault(); saveUnit();" class="p-6 space-y-4">
      <div>
        <label
          class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
          >Unit Number</label
        >
        <input
          type="text"
          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
          placeholder="e.g., A-101"
          required
        />
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Floor</label
          >
          <input
            type="text"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
            placeholder="e.g., Ground Floor"
          />
        </div>
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Building</label
          >
          <input
            type="text"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
            placeholder="e.g., Block A"
          />
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Electricity Meter</label
          >
          <input
            type="text"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
            placeholder="Serial e.g., E460-010"
          />
        </div>
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Water Meter</label
          >
          <input
            type="text"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
            placeholder="Serial e.g., WTR-010"
          />
        </div>
      </div>
      <div
        class="flex items-center justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700"
      >
        <button
          type="button"
          onclick="hideAddUnitModal()"
          class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-4 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg transition-colors"
        >
          <i class="fas fa-plus mr-2"></i>Create Unit
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="../../static/js/flash.js"></script>
    <script>
        // Unit Functions
        function showAddUnitModal() {
    document.getElementById("addUnitModal").classList.remove("hidden");
        }

        function hideAddUnitModal() {
    document.getElementById("addUnitModal").classList.add("hidden");
        }

        function saveUnit() {
    (async () => {
      try {
        const payload = collectUnitFormPayload();
        const resp = await fetch(`/api/v1/units`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          showFlashMessage('Failed to create unit', 'error', true);
        }
        await resp.json();
            hideAddUnitModal();
        window.location.reload();
        showFlashMessage('Unit created successfully', 'success', true);
      } catch (e) {
        showFlashMessage('Failed to create unit', 'error', true);
      }
    })();
        }

        function viewUnitDetails() {
    window.location.href = "meters.html";
  }

  function showEditUnitModal() {
    const modal = document.getElementById("editUnitModal");
    if (modal) modal.classList.remove("hidden");
  }

  function hideEditUnitModal() {
    const modal = document.getElementById("editUnitModal");
    if (modal) modal.classList.add("hidden");
  }

  function editUnit(buttonEl) {
    // Optionally populate fields from the row
    const row = buttonEl ? buttonEl.closest("tr") : null;
    if (row) {
      // capture unit id from data attribute and store on modal
      try {
        const data = JSON.parse(row.getAttribute('data-unit'));
        const modal = document.getElementById('editUnitModal');
        if (modal && data && data.id) modal.dataset.unitId = data.id;
      } catch (_) {}
      const unitLink = row.querySelector("td:nth-child(2) a");
      const floorText = row.querySelector("td:nth-child(2) p");
      const estateCell = row.querySelector("td:nth-child(3)");
      const emeter = row.querySelector("td:nth-child(5) span.font-mono");
      const wmeter = row.querySelector("td:nth-child(6) span.font-mono");
      const smeter = row.querySelector("td:nth-child(7) span.font-mono");

      const unitNumber = unitLink
        ? unitLink.textContent.trim().replace(/^Unit\s+/i, "")
        : "";
      const floor = floorText ? floorText.textContent.trim() : "";
      const estate = estateCell ? estateCell.textContent.trim() : "";

      const editUnitNumber = document.getElementById("edit_unit_number");
      const editUnitFloor = document.getElementById("edit_unit_floor");
      const editUnitEstate = document.getElementById("edit_unit_estate");
      const editEmeter = document.getElementById("edit_unit_emeter");
      const editWmeter = document.getElementById("edit_unit_wmeter");
      const editSmeter = document.getElementById("edit_unit_smeter");
      const editResident = document.getElementById("edit_unit_resident");

      if (editUnitNumber) editUnitNumber.value = unitNumber || "";
      if (editUnitFloor) editUnitFloor.value = floor || "";
      if (editUnitEstate) {
        // naive selection by text match
        Array.from(editUnitEstate.options).forEach((opt) => {
          opt.selected = opt.textContent.trim() === estate;
        });
      }
      if (editEmeter && emeter) editEmeter.value = emeter.textContent.trim();
      if (editWmeter && wmeter) editWmeter.value = wmeter.textContent.trim();
      if (editSmeter && smeter) editSmeter.value = smeter.textContent.trim();
      if (editResident && row.hasAttribute('data-unit')) {
        try {
          const udata = JSON.parse(row.getAttribute('data-unit'));
          if (udata && udata.resident && udata.resident.id) {
            editResident.value = String(udata.resident.id);
          } else {
            editResident.value = '';
          }
        } catch (_) { editResident.value = ''; }
      }
    }

    showEditUnitModal();
  }

  function saveEditedUnit() {
    (async () => {
      try {
        const modal = document.getElementById('editUnitModal');
        const unitDataAttr = modal && modal.dataset && modal.dataset.unitId ? { id: modal.dataset.unitId } : null;
        // Fallback: read from selected row data attribute if available
        let unitId = unitDataAttr ? unitDataAttr.id : null;
        if (!unitId) {
          const anySelected = document.querySelector('tr[data-unit]');
          if (anySelected) {
            try { unitId = JSON.parse(anySelected.getAttribute('data-unit')).id; } catch (_) {}
          }
        }
        if (!unitId) { alert('Missing unit id'); return; }

        const payload = collectEditUnitFormPayload();
        const resp = await fetch(`/api/v1/units/${unitId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          showFlashMessage("Failed to update unit", 'error', true);
        }
        await resp.json();
        hideEditUnitModal();
        window.location.reload();
        showFlashMessage('Unit updated successfully', 'success', true);
      } catch (e) {
        showFlashMessage("Failed to update unit", 'error', true);
      }
    })();
  }

  function collectUnitFormPayload() {
    // This demo collects minimal fields; expand when backend supports more
    const modal = document.getElementById('addUnitModal');
    const inputs = modal.querySelectorAll('input, select');
    const payload = {};
    inputs.forEach((el) => {
      const name = el.name || el.placeholder || el.id;
      if (name) payload[name] = el.value;
    });
    return payload;
  }

  function collectEditUnitFormPayload() {
    const modal = document.getElementById('editUnitModal');
    const payload = {
      unit_number: document.getElementById('edit_unit_number')?.value || '',
      floor: document.getElementById('edit_unit_floor')?.value || '',
      estate_id: document.getElementById('edit_unit_estate')?.value || null,
      electricity_meter_id: document.getElementById('edit_unit_emeter')?.value || null,
      water_meter_id: document.getElementById('edit_unit_wmeter')?.value || null,
      solar_meter_id: document.getElementById('edit_unit_smeter')?.value || null,
    };
    return payload;
        }

        function assignResident() {
    alert("Assign resident modal would open here");
        }

  // Delete Unit flow
  let deleteUnitId = null;
  window.confirmDeleteUnit = function(unitId) {
    try {
      deleteUnitId = unitId;
      const modal = document.getElementById('deleteUnitModal');
      if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
    } catch (e) { console.error(e); }
  }
  window.hideDeleteUnitModal = function() {
    try {
      const modal = document.getElementById('deleteUnitModal');
      if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
    } catch (e) { console.error(e); }
  }
  window.performDeleteUnit = async function() {
    try {
      if (!deleteUnitId) return;
      const resp = await fetch(`/api/v1/units/${deleteUnitId}`, { method: 'DELETE' });
      if (!resp.ok) {
        showFlashMessage("Failed to delete unit", 'error', true);
      }
      window.hideDeleteUnitModal();
      window.location.reload();
      showFlashMessage("Unit deleted successfully.", "success", true)
    } catch (e) { console.error(e); showFlashMessage("Error deleting unit. Try again later.", "error", true) }
        }

  // Filter Functions
  function applyFilters() {
    const form = document.getElementById('unitFilters');
    form.submit();
  }

  function clearFilters() {
    // Reset all form fields
    document.getElementById('searchInput').value = '';
    document.getElementById('estateFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    // Submit the form with cleared values
    const form = document.getElementById('unitFilters');
    form.submit();
  }


  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          applyFilters();
        }
      });
    }
  });
    </script>
{% endblock %}

