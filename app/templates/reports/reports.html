{% extends "base.html" %}

{% block title %}Reports - Quantify Metering System{% endblock %}

{% block page_title %}Reports{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('api_v1.index') }}" class="hover:text-primary">Home</a>
<span class="mx-1">/</span>
<span>Reports</span>
{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Report Categories Tabs -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
    <div class="border-b border-gray-200 dark:border-gray-600">
      <nav class="flex space-x-8 px-6" aria-label="Tabs">
        <a href="{{ url_for('api_v1.reports_page', category='consumption') }}" 
           class="py-4 px-1 border-b-2 font-medium text-sm transition-colors {% if category == 'consumption' %}border-primary text-primary{% else %}border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300{% endif %}">
          <i class="fas fa-chart-line mr-2"></i>Consumption Reports
        </a>
        
        <a href="{{ url_for('api_v1.reports_page', category='financial') }}" 
           class="py-4 px-1 border-b-2 font-medium text-sm transition-colors {% if category == 'financial' %}border-primary text-primary{% else %}border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300{% endif %}">
          <i class="fas fa-rand-sign mr-2"></i>Financial Reports
        </a>
        
        <a href="{{ url_for('api_v1.reports_page', category='system') }}" 
           class="py-4 px-1 border-b-2 font-medium text-sm transition-colors {% if category == 'system' %}border-primary text-primary{% else %}border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300{% endif %}">
          <i class="fas fa-cogs mr-2"></i>System & Status
        </a>
        
        <a href="{{ url_for('api_v1.reports_page', category='estate') }}" 
           class="py-4 px-1 border-b-2 font-medium text-sm transition-colors {% if category == 'estate' %}border-primary text-primary{% else %}border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300{% endif %}">
          <i class="fas fa-building mr-2"></i>Estate-Level Reports
        </a>
      </nav>
    </div>
  </div>

  <!-- Report Filters -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Report Filters</h3>
      <form method="get" class="flex items-end justify-between gap-4">
        <input type="hidden" name="category" value="{{ category }}">
        
        <div class="flex items-end gap-4 flex-1">
          <div class="min-w-0 flex-1">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date Range</label>
            <select name="date_range" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="current_month" {% if current_date_range == "current_month" %}selected{% endif %}>Current Month</option>
              <option value="previous_month" {% if current_date_range == "previous_month" %}selected{% endif %}>Previous Month</option>
              <option value="past_3_months" {% if current_date_range == "past_3_months" %}selected{% endif %}>Past 3 Months</option>
              <option value="year_to_date" {% if current_date_range == "year_to_date" %}selected{% endif %}>Year to Date</option>
            </select>
          </div>
          
          <div class="min-w-0 flex-1">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estate</label>
            <select name="estate_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="">All Estates</option>
              {% for estate in estates %}
              <option value="{{ estate.id }}" {% if current_estate == estate.id %}selected{% endif %}>{{ estate.name }}</option>
              {% endfor %}
            </select>
          </div>
          
          {% if category == "consumption" %}
          <div class="min-w-0 flex-1">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Meter Type</label>
            <select name="meter_type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="all" {% if current_meter_type == "all" %}selected{% endif %}>All Types</option>
              <option value="electricity" {% if current_meter_type == "electricity" %}selected{% endif %}>Electricity</option>
              <option value="water" {% if current_meter_type == "water" %}selected{% endif %}>Water</option>
              <option value="solar" {% if current_meter_type == "solar" %}selected{% endif %}>Solar</option>
            </select>
          </div>
          {% endif %}
        </div>
        
        <div class="flex items-end gap-2">
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
            <i class="fas fa-filter mr-2"></i>Apply Filters
          </button>
          <a href="{{ url_for('api_v1.reports_page') }}" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium">
            <i class="fas fa-times mr-2"></i>Clear Filters
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Report Content -->
  <div class="space-y-6">
    {% if category == "consumption" %}
      {% include "reports/consumption_reports.html" %}
    {% elif category == "financial" %}
      {% include "reports/financial_reports.html" %}
    {% elif category == "system" %}
      {% include "reports/system_reports.html" %}
    {% elif category == "estate" %}
      {% include "reports/estate_reports.html" %}
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Report configuration passed to external JS
  window.REPORT_CONFIG = {
    category: '{{ category }}',
    dateRange: '{{ current_date_range }}',
    estateId: {{ current_estate | tojson if current_estate else 'null' }},
    meterType: {{ current_meter_type | tojson if current_meter_type else 'null' }},
    dailyConsumptionTrend: {{ daily_consumption_trend | tojson if daily_consumption_trend is defined else '[]' }},
    bulkSubComparison: {{ bulk_sub_comparison | tojson if bulk_sub_comparison is defined else '[]' }},
    creditPurchases: {{ credit_purchases_json | tojson if credit_purchases_json is defined else '[]' }},
    estateUtilitySummary: {{ estate_utility_summary_json | tojson if estate_utility_summary_json is defined else '[]' }}
  };
</script>
<script src="{{ url_for('static', filename='js/reports/reports.js') }}"></script>
{% endblock %}