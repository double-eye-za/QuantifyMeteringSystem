{% extends "base.html" %}

{% block title %}Consumption Reports - Quantify Metering System{% endblock %}

{% block page_title %}Consumption Reports{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('api_v1.dashboard') }}" class="hover:text-primary">Home</a>
<span class="mx-1">/</span>
<span>Reports</span>
{% endblock %}

{% block content %}

        <!-- Report Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Consumption</span>
                    <i class="fas fa-chart-line text-primary"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ '%.0f' % (kpis.electricity_total_kwh or 0) }} kWh</div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ kpis.period_label }}</p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Revenue</span>
                    <i class="fas fa-rand-sign text-green-500"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white">R {{ '%.2f' % (kpis.revenue_total_amount or 0) }}</div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ kpis.period_label }}</p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Water Usage</span>
                    <i class="fas fa-tint text-blue-500"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ '%.0f' % (kpis.water_total_liters or 0) }} L</div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ kpis.period_label }}</p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Solar Generation</span>
                    <i class="fas fa-solar-panel text-yellow-500"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ '%.0f' % (kpis.solar_total_kwh or 0) }} kWh</div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ kpis.period_label }}</p>
            </div>
        </div>

        <!-- Report Filters -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Report Type</label>
                    <div class="relative">
                        <select class="w-full appearance-none bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg px-4 py-2 pr-10 cursor-pointer">
                            <option>Monthly Consumption Trend</option>
                            <option>Estate Comparison</option>
                            <option>Detailed Consumption Report</option>
                            <option>Quick Insights</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Period</label>
                    <div class="relative">
                        <select class="w-full appearance-none bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg px-4 py-2 pr-10 cursor-pointer">
                            <option>Today</option>
                            <option>Yesterday</option>
                            <option>Last 7 Days</option>
                            <option>This Month</option>
                            <option>Month to Date</option>
                            <option>Last Month</option>
                            <option>Last 3 Months</option>
                            <option>Last 6 Months</option>
                            <option>Year to Date</option>
                            <option>Custom Range</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estate</label>
                    <div class="relative">
                        <select class="w-full appearance-none bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg px-4 py-2 pr-10 cursor-pointer">
                            <option value="">All Estates</option>
                            {% for e in estates %}
                            <option value="{{ e.id }}">{{ e.name }}</option>
                            {% endfor %}
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Meter Type</label>
                    <div class="relative">
                        <select class="w-full appearance-none bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg px-4 py-2 pr-10 cursor-pointer">
                            <option>All Types</option>
                            <option>Electricity</option>
                            <option>Water</option>
                            <option>Solar</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="flex items-end">
                    <button class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">
                        <i class="fas fa-filter mr-2"></i>Generate Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Monthly Consumption Trend -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Monthly Consumption Trend</h3>
                </div>
                <div class="relative h-64">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- Estate Comparison -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Estate Comparison</h3>
                </div>
                <div class="relative h-64">
                    <canvas id="estateChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Report Table -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Detailed Consumption Report</h3>
                    <div class="flex space-x-2">
                        <button class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                            <i class="fas fa-file-pdf mr-2"></i>PDF
                        </button>
                        <button class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                            <i class="fas fa-file-excel mr-2"></i>Excel
                        </button>
                        <button class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                            <i class="fas fa-print mr-2"></i>Print
                        </button>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-6 py-3">Unit</th>
                            <th scope="col" class="px-6 py-3">Estate</th>
                            <th scope="col" class="px-6 py-3">Electricity (kWh)</th>
                            <th scope="col" class="px-6 py-3">Water (L)</th>
                            <th scope="col" class="px-6 py-3">Solar (kWh)</th>
                            <th scope="col" class="px-6 py-3">Total Cost</th>
                            <th scope="col" class="px-6 py-3">Payments</th>
                            <th scope="col" class="px-6 py-3">Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if detailed_report.no_data %}
                        <tr><td colspan="8" class="text-center py-4 text-gray-500">Not enough data for detailed report</td></tr>
                        {% else %}
                        {% set totals = namespace(elec=0.0, water=0.0, solar=0.0, cost=0.0, payments=0.0, balance=0.0) %}
                        {% for row in detailed_report.data %}
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ row.unit_number }}</td>
                            <td class="px-6 py-4">{{ row.estate_name }}</td>
                            <td class="px-6 py-4">{{ '%.0f' % row.elec_kwh }}</td>
                            <td class="px-6 py-4">{{ '%.0f' % row.water_l }}</td>
                            <td class="px-6 py-4">{{ '%.0f' % row.solar_kwh }}</td>
                            <td class="px-6 py-4 font-semibold">R {{ '%.2f' % row.total_cost }}</td>
                            <td class="px-6 py-4 text-green-600">R {{ '%.2f' % row.payments }}</td>
                            <td class="px-6 py-4 font-semibold {% if row.balance < 0 %}text-red-600{% else %}text-green-600{% endif %}">R {{ '%.2f' % row.balance }}</td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                    <tfoot class="bg-gray-50 dark:bg-gray-700">
                        {% if detailed_report.no_data %}
                        <tr class="font-semibold text-gray-900 dark:text-white">
                            <td class="px-6 py-4">Total</td>
                            <td class="px-6 py-4">-</td>
                            <td class="px-6 py-4">0</td>
                            <td class="px-6 py-4">0</td>
                            <td class="px-6 py-4">0</td>
                            <td class="px-6 py-4">R 0.00</td>
                            <td class="px-6 py-4 text-green-600">R 0.00</td>
                            <td class="px-6 py-4 text-green-600">R 0.00</td>
                        </tr>
                        {% else %}
                        {% set totals = namespace(elec=0.0, water=0.0, solar=0.0, cost=0.0, payments=0.0, balance=0.0) %}
                        {% for row in detailed_report.data %}
                            {% set totals.elec = totals.elec + row.elec_kwh %}
                            {% set totals.water = totals.water + row.water_l %}
                            {% set totals.solar = totals.solar + row.solar_kwh %}
                            {% set totals.cost = totals.cost + row.total_cost %}
                            {% set totals.payments = totals.payments + row.payments %}
                            {% set totals.balance = totals.balance + row.balance %}
                        {% endfor %}
                        <tr class="font-semibold text-gray-900 dark:text-white">
                            <td class="px-6 py-4">Total</td>
                            <td class="px-6 py-4">-</td>
                            <td class="px-6 py-4">{{ '%.0f' % totals.elec }}</td>
                            <td class="px-6 py-4">{{ '%.0f' % totals.water }}</td>
                            <td class="px-6 py-4">{{ '%.0f' % totals.solar }}</td>
                            <td class="px-6 py-4">R {{ '%.2f' % totals.cost }}</td>
                            <td class="px-6 py-4 text-green-600">R {{ '%.2f' % totals.payments }}</td>
                            <td class="px-6 py-4 {% if totals.balance < 0 %}text-red-600{% else %}text-green-600{% endif %}">R {{ '%.2f' % totals.balance }}</td>
                        </tr>
                        {% endif %}
                    </tfoot>
                </table>
            </div>

            <!-- Pagination -->
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-700 dark:text-gray-400">
                        Showing <span class="font-medium">{{ detailed_report.start_display }}</span> to <span class="font-medium">{{ detailed_report.end_display }}</span> of <span class="font-medium">{{ detailed_report.total }}</span> results
                    </span>
                    <div class="flex space-x-1">
                        <button {% if not detailed_report.prev_page %}disabled class="opacity-50 cursor-not-allowed"{% endif %} class="px-3 py-2 text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-l-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            Previous
                        </button>
                        {% for p in range(1, detailed_report.pages + 1) %}
                        <button {% if p == detailed_report.page %}class="px-3 py-2 text-sm bg-primary text-white rounded-lg"{% else %}class="px-3 py-2 text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700"{% endif %}>{{ p }}</button>
                        {% endfor %}
                        <button {% if not detailed_report.next_page %}disabled class="opacity-50 cursor-not-allowed"{% endif %} class="px-3 py-2 text-sm bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-r-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Insights -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quick Insights</h3>
            {% if quick_insights.no_data %}
            <div class="text-center text-gray-500 py-4">No data available for insights</div>
            {% else %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex items-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                    <i class="fas fa-chart-line text-blue-500 text-xl mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Peak consumption time</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400">{{ quick_insights.peak_time }} daily</p>
                    </div>
                </div>
                <div class="flex items-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                    <i class="fas fa-award text-green-500 text-xl mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Most efficient unit</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400">{{ quick_insights.most_efficient }}</p>
                    </div>
                </div>
                <div class="flex items-center p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">High consumption alert</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400">{{ quick_insights.high_alert }}</p>
                    </div>
                </div>
                <div class="flex items-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                    <i class="fas fa-solar-panel text-purple-500 text-xl mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Solar contribution</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400">{{ quick_insights.solar_contrib }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
        // Monthly Consumption Chart
        const monthlyCtx = document.getElementById('monthlyChart');
        const monthlyData = {{ monthly_chart | tojson }};
        if (monthlyData.no_data) {
            monthlyCtx.parentElement.innerHTML = '<div class="text-center text-gray-500 py-8">Not enough data for monthly trend</div>';
        } else {
            new Chart(monthlyCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Electricity (kWh)',
                        data: monthlyData.electricity_kwh,
                        borderColor: '#FBBC04',
                        backgroundColor: 'rgba(251, 188, 4, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Water (L x100)',
                        data: monthlyData.water_hl,
                        borderColor: '#1A73E8',
                        backgroundColor: 'rgba(26, 115, 232, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Solar (kWh)',
                        data: monthlyData.solar_kwh,
                        borderColor: '#34A853',
                        backgroundColor: 'rgba(52, 168, 83, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Estate Comparison Chart
        const estateCtx = document.getElementById('estateChart');
        const estateData = {{ estate_comparison | tojson }};
        if (estateData.no_data) {
            estateCtx.parentElement.innerHTML = '<div class="text-center text-gray-500 py-8">Not enough data for estate comparison</div>';
        } else {
            new Chart(estateCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: estateData.labels,
                    datasets: estateData.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Alerts for no data
        const alertsContainer = document.createElement('div');
        alertsContainer.className = 'mb-6';
        if (monthlyData.no_data || estateData.no_data || {{ detailed_report.no_data | tojson }} || {{ quick_insights.no_data | tojson }}) {
            alertsContainer.innerHTML = `
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded">
                    <p class="font-bold">Alert: Insufficient data for charts</p>
                    <p>Please check meter readings and ensure data is available.</p>
                </div>
            `;
            document.querySelector('#content').insertBefore(alertsContainer, document.querySelector('.grid.grid-cols-1.lg\\:grid-cols-2'));
        }
</script>
{% endblock %}