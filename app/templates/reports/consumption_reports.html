<!-- Consumption Reports -->
<div class="space-y-6">
  <!-- Unit Consumption Summary -->
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700"
  >
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Unit Consumption Summary
        </h3>
        <div class="flex space-x-2">
          <button
            onclick="exportReport('unit_consumption', 'csv')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
          >
            <i class="fas fa-file-csv mr-2"></i>CSV
          </button>
          <button
            onclick="exportReport('unit_consumption', 'pdf')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
          >
            <i class="fas fa-file-pdf mr-2"></i>PDF
          </button>
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
        <thead
          class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
        >
          <tr>
            <th class="px-6 py-3">Unit Number</th>
            <th class="px-6 py-3">Estate</th>
            <th class="px-6 py-3">Electricity (kWh)</th>
            <th class="px-6 py-3">Water (kL)</th>
            <th class="px-6 py-3">Hot Water (kL)</th>
            <th class="px-6 py-3">Solar (kWh)</th>
            <th class="px-6 py-3">Total Consumption</th>
          </tr>
        </thead>
        <tbody>
          {% if unit_consumption %} {% for row in unit_consumption %}
          <tr
            class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600"
          >
            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
              {{ row.unit_number }}
            </td>
            <td class="px-6 py-4">{{ row.estate_name }}</td>
            <td class="px-6 py-4">
              {{ (row.electricity_kwh or 0) | format_number(2) }}
            </td>
            <td class="px-6 py-4">{{ (row.water_kL or 0) | format_number(2) }}</td>
            <td class="px-6 py-4">{{ (row.hot_water_kL or 0) | format_number(2) }}</td>
            <td class="px-6 py-4">{{ (row.solar_kwh or 0) | format_number(2) }}</td>
            <td class="px-6 py-4 font-semibold">
              {{ ((row.electricity_kwh or 0) + (row.water_kL or 0) + (row.hot_water_kL or 0) + (row.solar_kwh or 0)) | format_number(2) }}
            </td>
          </tr>
          {% endfor %} {% else %}
          <tr>
            <td
              colspan="6"
              class="text-center py-8 text-gray-500 dark:text-gray-400"
            >
              No consumption data available for the selected period
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    
    <!-- Pagination for Unit Consumption -->
    {% if unit_consumption_pagination %}
    <!-- Pagination -->
    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <div class="text-sm text-gray-700 dark:text-gray-300">
        Showing <span class="font-medium">{{ ((unit_consumption_pagination.page - 1) * unit_consumption_pagination.per_page + 1) if unit_consumption_pagination.total > 0 else 0 }}</span>
        to <span class="font-medium">{{ unit_consumption_pagination.page * unit_consumption_pagination.per_page if unit_consumption_pagination.page * unit_consumption_pagination.per_page < unit_consumption_pagination.total else unit_consumption_pagination.total }}</span>
        of <span class="font-medium">{{ unit_consumption_pagination.total }}</span> results
      </div>
      <div class="flex items-center gap-2">
        <a href="?category={{ category }}&unit_page={{ unit_consumption_pagination.page - 1 }}{% if current_estate %}&estate_id={{ current_estate }}{% endif %}{% if current_date_range %}&date_range={{ current_date_range }}{% endif %}{% if current_meter_type %}&meter_type={{ current_meter_type }}{% endif %}{% if top_consumers_page %}&top_page={{ top_consumers_page }}{% endif %}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not unit_consumption_pagination.has_prev }}">
          <i class="fas fa-chevron-left"></i>
        </a>
        <span class="px-3 py-1 bg-primary text-white rounded-lg">{{ unit_consumption_pagination.page }}</span>
        <a href="?category={{ category }}&unit_page={{ unit_consumption_pagination.page + 1 }}{% if current_estate %}&estate_id={{ current_estate }}{% endif %}{% if current_date_range %}&date_range={{ current_date_range }}{% endif %}{% if current_meter_type %}&meter_type={{ current_meter_type }}{% endif %}{% if top_consumers_page %}&top_page={{ top_consumers_page }}{% endif %}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not unit_consumption_pagination.has_next }}">
          <i class="fas fa-chevron-right"></i>
        </a>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Bulk vs Sub-Meter Comparison -->
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700"
  >
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Bulk vs Sub-Meter Comparison
        </h3>
        <div class="flex space-x-2">
          <button
            onclick="exportReport('bulk_sub_comparison', 'csv')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
          >
            <i class="fas fa-file-csv mr-2"></i>CSV
          </button>
          <button
            onclick="exportReport('bulk_sub_comparison', 'pdf')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
          >
            <i class="fas fa-file-pdf mr-2"></i>PDF
          </button>
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
        <thead
          class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
        >
          <tr>
            <th class="px-6 py-3">Estate</th>
            <th class="px-6 py-3">Bulk Electricity (kWh)</th>
            <th class="px-6 py-3">Sub Electricity (kWh)</th>
            <th class="px-6 py-3">Communal Electricity (kWh)</th>
            <th class="px-6 py-3">Bulk Water (kL)</th>
            <th class="px-6 py-3">Sub Water (kL)</th>
            <th class="px-6 py-3">Communal Water (kL)</th>
          </tr>
        </thead>
        <tbody>
          {% if bulk_sub_comparison %} {% for row in bulk_sub_comparison %}
          <tr
            class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600"
          >
            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
              {{ row.estate_name }}
            </td>
            <td class="px-6 py-4">
              {{ (row.bulk_electricity or 0) | format_number(2) }}
            </td>
            <td class="px-6 py-4">
              {{ (row.sub_electricity or 0) | format_number(2) }}
            </td>
            <td
              class="px-6 py-4 font-semibold {% if (row.communal_electricity or 0) < 0 %}text-red-600{% else %}text-green-600{% endif %}"
            >
              {{ (row.communal_electricity or 0) | format_number(2) }}
            </td>
            <td class="px-6 py-4">{{ (row.bulk_water or 0) | format_number(2) }}</td>
            <td class="px-6 py-4">{{ (row.sub_water or 0) | format_number(2) }}</td>
            <td
              class="px-6 py-4 font-semibold {% if (row.communal_water or 0) < 0 %}text-red-600{% else %}text-green-600{% endif %}"
            >
              {{ (row.communal_water or 0) | format_number(2) }}
            </td>
          </tr>
          {% endfor %} {% else %}
          <tr>
            <td
              colspan="7"
              class="text-center py-8 text-gray-500 dark:text-gray-400"
            >
              No bulk meter data available for comparison
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Top Consumers by Utility Type -->
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700"
  >
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Top Consumers by Utility Type
        </h3>
        <div class="flex space-x-1">
          <button
            onclick="showTopConsumersTab('electricity')"
            id="electricity-tab"
            class="px-3 py-1 text-sm bg-primary text-white rounded-lg"
          >
            Electricity
          </button>
          <button
            onclick="showTopConsumersTab('water')"
            id="water-tab"
            class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
          >
            Water
          </button>
          <button
            onclick="showTopConsumersTab('hot_water')"
            id="hot_water-tab"
            class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
          >
            Hot Water
          </button>
          <button
            onclick="showTopConsumersTab('solar')"
            id="solar-tab"
            class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
          >
            Solar
          </button>
        </div>
      </div>
    </div>

    <!-- Electricity Tab Content -->
    <div id="electricity-content" class="top-consumers-content">
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
              <th class="px-6 py-3">Rank</th>
              <th class="px-6 py-3">Unit Number</th>
              <th class="px-6 py-3">Estate</th>
              <th class="px-6 py-3">Utility Type</th>
              <th class="px-6 py-3">Total Consumption</th>
            </tr>
          </thead>
          <tbody>
            {% if top_consumers_electricity.data %}
              {% for row in top_consumers_electricity.data %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                  <td class="px-6 py-4 font-semibold text-primary">{{ loop.index }}</td>
                  <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ row.unit_number }}</td>
                  <td class="px-6 py-4">{{ row.estate_name }}</td>
                  <td class="px-6 py-4">
                    <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                      {{ row.meter_type.title() }}
                    </span>
                  </td>
                  <td class="px-6 py-4 font-semibold">{{ (row.total_consumption or 0) | format_number(2) }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center py-8 text-gray-500 dark:text-gray-400">
                  No electricity consumption data available for ranking
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      
      <!-- Pagination for Electricity -->
      {% if top_consumers_electricity.pagination %}
      <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <div class="text-sm text-gray-700 dark:text-gray-300">
          Showing <span class="font-medium">{{ ((top_consumers_electricity.pagination.page - 1) * top_consumers_electricity.pagination.per_page + 1) if top_consumers_electricity.pagination.total > 0 else 0 }}</span>
          to <span class="font-medium">{{ top_consumers_electricity.pagination.page * top_consumers_electricity.pagination.per_page if top_consumers_electricity.pagination.page * top_consumers_electricity.pagination.per_page < top_consumers_electricity.pagination.total else top_consumers_electricity.pagination.total }}</span>
          of <span class="font-medium">{{ top_consumers_electricity.pagination.total }}</span> results
        </div>
        <div class="flex items-center gap-2">
          <a href="?category={{ category }}&top_page={{ top_consumers_electricity.pagination.page - 1 }}{% if current_estate %}&estate_id={{ current_estate }}{% endif %}{% if current_date_range %}&date_range={{ current_date_range }}{% endif %}{% if current_meter_type %}&meter_type={{ current_meter_type }}{% endif %}{% if unit_page %}&unit_page={{ unit_page }}{% endif %}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not top_consumers_electricity.pagination.has_prev }}">
            <i class="fas fa-chevron-left"></i>
          </a>
          <span class="px-3 py-1 bg-primary text-white rounded-lg">{{ top_consumers_electricity.pagination.page }}</span>
          <a href="?category={{ category }}&top_page={{ top_consumers_electricity.pagination.page + 1 }}{% if current_estate %}&estate_id={{ current_estate }}{% endif %}{% if current_date_range %}&date_range={{ current_date_range }}{% endif %}{% if current_meter_type %}&meter_type={{ current_meter_type }}{% endif %}{% if unit_page %}&unit_page={{ unit_page }}{% endif %}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not top_consumers_electricity.pagination.has_next }}">
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Water Tab Content -->
    <div id="water-content" class="top-consumers-content hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
              <th class="px-6 py-3">Rank</th>
              <th class="px-6 py-3">Unit Number</th>
              <th class="px-6 py-3">Estate</th>
              <th class="px-6 py-3">Utility Type</th>
              <th class="px-6 py-3">Total Consumption</th>
            </tr>
          </thead>
          <tbody>
            {% if top_consumers_water.data %}
              {% for row in top_consumers_water.data %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                  <td class="px-6 py-4 font-semibold text-primary">{{ loop.index }}</td>
                  <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ row.unit_number }}</td>
                  <td class="px-6 py-4">{{ row.estate_name }}</td>
                  <td class="px-6 py-4">
                    <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                      {{ row.meter_type.title() }}
                    </span>
                  </td>
                  <td class="px-6 py-4 font-semibold">{{ (row.total_consumption or 0) | format_number(2) }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center py-8 text-gray-500 dark:text-gray-400">
                  No water consumption data available for ranking
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      
      <!-- Pagination for Water -->
      {% if top_consumers_water.pagination %}
      <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <div class="text-sm text-gray-700 dark:text-gray-300">
          Showing <span class="font-medium">{{ ((top_consumers_water.pagination.page - 1) * top_consumers_water.pagination.per_page + 1) if top_consumers_water.pagination.total > 0 else 0 }}</span>
          to <span class="font-medium">{{ top_consumers_water.pagination.page * top_consumers_water.pagination.per_page if top_consumers_water.pagination.page * top_consumers_water.pagination.per_page < top_consumers_water.pagination.total else top_consumers_water.pagination.total }}</span>
          of <span class="font-medium">{{ top_consumers_water.pagination.total }}</span> results
        </div>
        <div class="flex items-center gap-2">
          <a href="?category={{ category }}&top_page={{ top_consumers_water.pagination.page - 1 }}{% if current_estate %}&estate_id={{ current_estate }}{% endif %}{% if current_date_range %}&date_range={{ current_date_range }}{% endif %}{% if current_meter_type %}&meter_type={{ current_meter_type }}{% endif %}{% if unit_page %}&unit_page={{ unit_page }}{% endif %}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not top_consumers_water.pagination.has_prev }}">
            <i class="fas fa-chevron-left"></i>
          </a>
          <span class="px-3 py-1 bg-primary text-white rounded-lg">{{ top_consumers_water.pagination.page }}</span>
          <a href="?category={{ category }}&top_page={{ top_consumers_water.pagination.page + 1 }}{% if current_estate %}&estate_id={{ current_estate }}{% endif %}{% if current_date_range %}&date_range={{ current_date_range }}{% endif %}{% if current_meter_type %}&meter_type={{ current_meter_type }}{% endif %}{% if unit_page %}&unit_page={{ unit_page }}{% endif %}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not top_consumers_water.pagination.has_next }}">
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Solar Tab Content -->
    <div id="solar-content" class="top-consumers-content hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
              <th class="px-6 py-3">Rank</th>
              <th class="px-6 py-3">Unit Number</th>
              <th class="px-6 py-3">Estate</th>
              <th class="px-6 py-3">Utility Type</th>
              <th class="px-6 py-3">Total Consumption</th>
            </tr>
          </thead>
          <tbody>
            {% if top_consumers_solar.data %}
              {% for row in top_consumers_solar.data %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                  <td class="px-6 py-4 font-semibold text-primary">{{ loop.index }}</td>
                  <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ row.unit_number }}</td>
                  <td class="px-6 py-4">{{ row.estate_name }}</td>
                  <td class="px-6 py-4">
                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                      {{ row.meter_type.title() }}
                    </span>
                  </td>
                  <td class="px-6 py-4 font-semibold">{{ (row.total_consumption or 0) | format_number(2) }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center py-8 text-gray-500 dark:text-gray-400">
                  No solar consumption data available for ranking
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      
      <!-- Pagination for Solar -->
      {% if top_consumers_solar.pagination %}
      <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <div class="text-sm text-gray-700 dark:text-gray-300">
          Showing <span class="font-medium">{{ ((top_consumers_solar.pagination.page - 1) * top_consumers_solar.pagination.per_page + 1) if top_consumers_solar.pagination.total > 0 else 0 }}</span>
          to <span class="font-medium">{{ top_consumers_solar.pagination.page * top_consumers_solar.pagination.per_page if top_consumers_solar.pagination.page * top_consumers_solar.pagination.per_page < top_consumers_solar.pagination.total else top_consumers_solar.pagination.total }}</span>
          of <span class="font-medium">{{ top_consumers_solar.pagination.total }}</span> results
        </div>
        <div class="flex items-center gap-2">
          <a href="?category={{ category }}&top_page={{ top_consumers_solar.pagination.page - 1 }}{% if current_estate %}&estate_id={{ current_estate }}{% endif %}{% if current_date_range %}&date_range={{ current_date_range }}{% endif %}{% if current_meter_type %}&meter_type={{ current_meter_type }}{% endif %}{% if unit_page %}&unit_page={{ unit_page }}{% endif %}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not top_consumers_solar.pagination.has_prev }}">
            <i class="fas fa-chevron-left"></i>
          </a>
          <span class="px-3 py-1 bg-primary text-white rounded-lg">{{ top_consumers_solar.pagination.page }}</span>
          <a href="?category={{ category }}&top_page={{ top_consumers_solar.pagination.page + 1 }}{% if current_estate %}&estate_id={{ current_estate }}{% endif %}{% if current_date_range %}&date_range={{ current_date_range }}{% endif %}{% if current_meter_type %}&meter_type={{ current_meter_type }}{% endif %}{% if unit_page %}&unit_page={{ unit_page }}{% endif %}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not top_consumers_solar.pagination.has_next }}">
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

    <!-- Hot Water Tab Content -->
    <div id="hot_water-content" class="top-consumers-content hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
              <th class="px-6 py-3">Rank</th>
              <th class="px-6 py-3">Unit Number</th>
              <th class="px-6 py-3">Estate</th>
              <th class="px-6 py-3">Utility Type</th>
              <th class="px-6 py-3">Total Consumption</th>
            </tr>
          </thead>
          <tbody>
            {% if top_consumers_hot_water.data %}
              {% for row in top_consumers_hot_water.data %}
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                  <td class="px-6 py-4 font-semibold text-primary">{{ loop.index }}</td>
                  <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ row.unit_number }}</td>
                  <td class="px-6 py-4">{{ row.estate_name }}</td>
                  <td class="px-6 py-4">
                    <span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200">
                      {{ row.meter_type.title() }}
                    </span>
                  </td>
                  <td class="px-6 py-4 font-semibold">{{ (row.total_consumption or 0) | format_number(2) }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center py-8 text-gray-500 dark:text-gray-400">
                  No hot water consumption data available for ranking
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% if top_consumers_hot_water.pagination %}
      <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <div class="text-sm text-gray-700 dark:text-gray-300">
          Showing <span class="font-medium">{{ ((top_consumers_hot_water.pagination.page - 1) * top_consumers_hot_water.pagination.per_page + 1) if top_consumers_hot_water.pagination.total > 0 else 0 }}</span>
          to <span class="font-medium">{{ top_consumers_hot_water.pagination.page * top_consumers_hot_water.pagination.per_page if top_consumers_hot_water.pagination.page * top_consumers_hot_water.pagination.per_page < top_consumers_hot_water.pagination.total else top_consumers_hot_water.pagination.total }}</span>
          of <span class="font-medium">{{ top_consumers_hot_water.pagination.total }}</span> results
        </div>
        <div class="flex items-center gap-2">
          <a href="?category={{ category }}&top_page={{ top_consumers_hot_water.pagination.page - 1 }}{% if current_estate %}&estate_id={{ current_estate }}{% endif %}{% if current_date_range %}&date_range={{ current_date_range }}{% endif %}{% if current_meter_type %}&meter_type={{ current_meter_type }}{% endif %}{% if unit_page %}&unit_page={{ unit_page }}{% endif %}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not top_consumers_hot_water.pagination.has_prev }}">
            <i class="fas fa-chevron-left"></i>
          </a>
          <span class="px-3 py-1 bg-primary text-white rounded-lg">{{ top_consumers_hot_water.pagination.page }}</span>
          <a href="?category={{ category }}&top_page={{ top_consumers_hot_water.pagination.page + 1 }}{% if current_estate %}&estate_id={{ current_estate }}{% endif %}{% if current_date_range %}&date_range={{ current_date_range }}{% endif %}{% if current_meter_type %}&meter_type={{ current_meter_type }}{% endif %}{% if unit_page %}&unit_page={{ unit_page }}{% endif %}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 {{ 'pointer-events-none opacity-50' if not top_consumers_hot_water.pagination.has_next }}">
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>
      {% endif %}
    </div>

  <!-- Daily Consumption Trend Chart -->
  {% if unit_consumption %}
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700"
  >
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Daily Consumption Trend
      </h3>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        Daily consumption patterns over the selected period
      </p>
    </div>
    <div class="p-6">
      <div class="relative h-64">
        <canvas id="dailyConsumptionChart"></canvas>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Estate Comparison Chart -->
  {% if bulk_sub_comparison %}
  <div
    class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700"
  >
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Estate Consumption Comparison
      </h3>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        Bulk vs Sub-meter consumption by estate
      </p>
    </div>
    <div class="p-6">
      <div class="relative h-64">
        <canvas id="estateComparisonChart"></canvas>
      </div>
    </div>
  </div>
  {% endif %}
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Solar Generation vs Usage
        </h3>
        <div class="flex space-x-2">
          <button
            onclick="exportReport('solar_generation_vs_usage', 'csv')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
          >
            <i class="fas fa-file-csv mr-2"></i>CSV
          </button>
          <button
            onclick="exportReport('solar_generation_vs_usage', 'pdf')"
            class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
          >
            <i class="fas fa-file-pdf mr-2"></i>PDF
          </button>
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
        <thead
          class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
        >
          <tr>
            <th class="px-6 py-3">Estate</th>
            <th class="px-6 py-3">Solar Generation (kWh)</th>
            <th class="px-6 py-3">Electricity Usage (kWh)</th>
            <th class="px-6 py-3">Solar Contribution (%)</th>
            <th class="px-6 py-3">Net Usage (kWh)</th>
          </tr>
        </thead>
        <tbody>
          {% if solar_generation_vs_usage %} {% for row in
          solar_generation_vs_usage %} {% set solar_contribution =
          ((row.solar_generation or 0) / (row.electricity_usage or 1)) * 100 %}
          {% set net_usage = (row.electricity_usage or 0) -
          (row.solar_generation or 0) %}
          <tr
            class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600"
          >
            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
              {{ row.estate_name }}
            </td>
            <td class="px-6 py-4 text-green-600">
              {{ (row.solar_generation or 0) | format_number(2) }}
            </td>
            <td class="px-6 py-4">
              {{ (row.electricity_usage or 0) | format_number(2) }}
            </td>
            <td class="px-6 py-4 font-semibold text-green-600">
              {{ "%.1f"|format(solar_contribution) }}%
            </td>
            <td
              class="px-6 py-4 font-semibold {% if net_usage < 0 %}text-green-600{% else %}text-gray-900 dark:text-white{% endif %}"
            >
              {{ net_usage | format_number(2) }}
            </td>
          </tr>
          {% endfor %} {% else %}
          <tr>
            <td
              colspan="5"
              class="text-center py-8 text-gray-500 dark:text-gray-400"
            >
              No solar generation data available
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
<script>
  // Tab switching functionality for top consumers
  function showTopConsumersTab(utilityType) {
    // Hide all content
    const contents = document.querySelectorAll('.top-consumers-content');
    contents.forEach(content => content.classList.add('hidden'));
    
    // Remove active state from all tabs
    const tabs = document.querySelectorAll('[id$="-tab"]');
    tabs.forEach(tab => {
      tab.classList.remove('bg-primary', 'text-white');
      tab.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
    });
    
    // Show selected content
    const selectedContent = document.getElementById(utilityType + '-content');
    if (selectedContent) {
      selectedContent.classList.remove('hidden');
    }
    
    // Activate selected tab
    const selectedTab = document.getElementById(utilityType + '-tab');
    if (selectedTab) {
      selectedTab.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
      selectedTab.classList.add('bg-primary', 'text-white');
    }
  }
</script>
<script>
  // Helper function to detect dark mode
  function isDarkMode() {
    return document.documentElement.classList.contains('dark');
  }

  // Helper function to get chart colors based on theme
  function getChartColors() {
    return {
      text: isDarkMode() ? '#ffffff' : '#000000',
      grid: isDarkMode() ? '#374151' : '#e5e7eb',
      background: isDarkMode() ? 'rgba(31, 41, 55, 0.1)' : 'rgba(255, 255, 255, 0.1)'
    };
  }

  // Daily Consumption Trend Chart
  {% if unit_consumption %}
  const dailyConsumptionCtx = document.getElementById('dailyConsumptionChart').getContext('2d');
  
  // Generate sample daily data for the last 30 days
  const days = [];
  const electricityData = [];
  const waterData = [];
  const hotWaterData = [];
  const solarData = [];
  
  for (let i = 29; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    
    // Generate realistic consumption data with some variation
    electricityData.push(Math.floor(Math.random() * 50) + 20);
    waterData.push(Math.floor(Math.random() * 20) + 5);
    hotWaterData.push(Math.floor(Math.random() * 15) + 3);
    solarData.push(Math.floor(Math.random() * 30) + 10);
  }
  
  const colors = getChartColors();
  
  const dailyConsumptionChart = new Chart(dailyConsumptionCtx, {
    type: 'line',
    data: {
      labels: days,
      datasets: [{
        label: 'Electricity (kWh)',
        data: electricityData,
        borderColor: '#F59E0B',
        backgroundColor: 'rgba(245, 158, 11, 0.1)',
        borderWidth: 2,
        fill: false,
        tension: 0.4
      }, {
        label: 'Water (kL)',
        data: waterData,
        borderColor: '#3B82F6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderWidth: 2,
        fill: false,
        tension: 0.4
      }, {
        label: 'Hot Water (kL)',
        data: hotWaterData,
        borderColor: '#F97316',
        backgroundColor: 'rgba(249, 115, 22, 0.1)',
        borderWidth: 2,
        fill: false,
        tension: 0.4
      }, {
        label: 'Solar (kWh)',
        data: solarData,
        borderColor: '#10B981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        borderWidth: 2,
        fill: false,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            color: colors.text,
            font: {
              size: 12
            }
          },
          grid: {
            color: colors.grid
          },
          title: {
            display: true,
            text: 'Consumption',
            color: colors.text,
            font: {
              size: 14,
              weight: 'bold'
            }
          }
        },
        x: {
          ticks: {
            color: colors.text,
            font: {
              size: 12
            }
          },
          grid: {
            color: colors.grid
          },
          title: {
            display: true,
            text: 'Date',
            color: colors.text,
            font: {
              size: 14,
              weight: 'bold'
            }
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: colors.text,
            font: {
              size: 12,
              weight: 'bold'
            },
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
      
      }
    }
  });
  {% endif %}

  // Estate Comparison Chart
  {% if bulk_sub_comparison %}
  const estateComparisonCtx = document.getElementById('estateComparisonChart').getContext('2d');
  
  const estateComparisonChart = new Chart(estateComparisonCtx, {
    type: 'bar',
    data: {
      labels: [
        {% for row in bulk_sub_comparison %}
          '{{ row.estate_name }}'{% if not loop.last %},{% endif %}
        {% endfor %}
      ],
      datasets: [{
        label: 'Bulk Consumption',
        data: [
          {% for row in bulk_sub_comparison %}
            {{ (row.bulk_electricity or 0) + (row.bulk_water or 0) }}{% if not loop.last %},{% endif %}
          {% endfor %}
        ],
        backgroundColor: '#3B82F6',
        borderWidth: 1,
        borderColor: isDarkMode() ? '#1f2937' : '#ffffff'
      }, {
        label: 'Sub-meter Consumption',
        data: [
          {% for row in bulk_sub_comparison %}
            {{ (row.sub_electricity or 0) + (row.sub_water or 0) }}{% if not loop.last %},{% endif %}
          {% endfor %}
        ],
        backgroundColor: '#10B981',
        borderWidth: 1,
        borderColor: isDarkMode() ? '#1f2937' : '#ffffff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            color: colors.text,
            font: {
              size: 12
            }
          },
          grid: {
            color: colors.grid
          },
          title: {
            display: true,
            text: 'Consumption',
            color: colors.text,
            font: {
              size: 14,
              weight: 'bold'
            }
          }
        },
        x: {
          ticks: {
            color: colors.text,
            font: {
              size: 12
            }
          },
          grid: {
            color: colors.grid
          },
          title: {
            display: true,
            text: 'Estate',
            color: colors.text,
            font: {
              size: 14,
              weight: 'bold'
            }
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: colors.text,
            font: {
              size: 12,
              weight: 'bold'
            },
            usePointStyle: true,
            pointStyle: 'rect'
          }
        },
        
      }
    }
  });
  {% endif %}

  // Listen for dark mode changes and update charts
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        // Update chart colors when dark mode changes
        const colors = getChartColors();
        
        {% if unit_consumption %}
        if (typeof dailyConsumptionChart !== 'undefined') {
          dailyConsumptionChart.options.scales.y.ticks.color = colors.text;
          dailyConsumptionChart.options.scales.x.ticks.color = colors.text;
          dailyConsumptionChart.options.scales.y.grid.color = colors.grid;
          dailyConsumptionChart.options.scales.x.grid.color = colors.grid;
          dailyConsumptionChart.options.scales.y.title.color = colors.text;
          dailyConsumptionChart.options.scales.x.title.color = colors.text;
          dailyConsumptionChart.options.plugins.legend.labels.color = colors.text;
          dailyConsumptionChart.options.plugins.title.color = colors.text;
          dailyConsumptionChart.update();
        }
        {% endif %}
        
        {% if bulk_sub_comparison %}
        if (typeof estateComparisonChart !== 'undefined') {
          estateComparisonChart.options.scales.y.ticks.color = colors.text;
          estateComparisonChart.options.scales.x.ticks.color = colors.text;
          estateComparisonChart.options.scales.y.grid.color = colors.grid;
          estateComparisonChart.options.scales.x.grid.color = colors.grid;
          estateComparisonChart.options.scales.y.title.color = colors.text;
          estateComparisonChart.options.scales.x.title.color = colors.text;
          estateComparisonChart.options.plugins.legend.labels.color = colors.text;
          estateComparisonChart.options.plugins.title.color = colors.text;
          estateComparisonChart.update();
        }
        {% endif %}
      }
    });
  });

  // Start observing
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class']
  });
</script>
