{% extends "base.html" %}
{% block title %}Compose Message - Quantify Metering System{% endblock %}
{% block page_title %}Compose Message{% endblock %}
{% block breadcrumb %}
<a href="{{ url_for('api_v1.dashboard') }}" class="hover:text-primary">Home</a>
<span class="mx-1">/</span>
<a href="{{ url_for('api_v1.messages_page') }}" class="hover:text-primary">Messages</a>
<span class="mx-1">/</span>
<span>Compose</span>
{% endblock %}
{% block content %}
  <div class="max-w-3xl mx-auto">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
          <i class="fas fa-paper-plane mr-2 text-primary"></i>New Message
        </h2>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Send a message to mobile app users</p>
      </div>

      <form id="composeForm" class="p-6 space-y-6">
        <!-- Recipient Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Send To</label>
          <div class="grid grid-cols-3 gap-3">
            <label class="relative cursor-pointer">
              <input type="radio" name="message_type" value="broadcast" class="peer sr-only" checked>
              <div class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-primary peer-checked:bg-primary/5 transition-all text-center">
                <i class="fas fa-bullhorn text-2xl text-gray-400 dark:text-gray-500 peer-checked:text-primary mb-2"></i>
                <div class="text-sm font-medium text-gray-900 dark:text-white">All Users</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Broadcast to everyone</div>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" name="message_type" value="estate" class="peer sr-only">
              <div class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-primary peer-checked:bg-primary/5 transition-all text-center">
                <i class="fas fa-building text-2xl text-gray-400 dark:text-gray-500 peer-checked:text-primary mb-2"></i>
                <div class="text-sm font-medium text-gray-900 dark:text-white">Estate</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">All users in an estate</div>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" name="message_type" value="individual" class="peer sr-only">
              <div class="p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-primary peer-checked:bg-primary/5 transition-all text-center">
                <i class="fas fa-user text-2xl text-gray-400 dark:text-gray-500 peer-checked:text-primary mb-2"></i>
                <div class="text-sm font-medium text-gray-900 dark:text-white">Individual</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">One specific user</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Estate Selector (hidden by default) -->
        <div id="estateSelector" class="hidden">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Estate</label>
          <select
            id="estateSelect"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-primary"
          >
            <option value="">Choose an estate...</option>
            {% for estate in estates %}
            <option value="{{ estate.id }}">{{ estate.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Individual Person Selector (hidden by default) -->
        <div id="personSelector" class="hidden">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Recipient</label>
          <div class="relative">
            <input
              type="text"
              id="personSearch"
              placeholder="Search by name or email..."
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-primary"
            />
            <input type="hidden" id="selectedPersonId" name="recipient_person_id">
            <div id="personResults" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg hidden max-h-60 overflow-y-auto"></div>
          </div>
          <div id="selectedPerson" class="mt-2 hidden">
            <div class="inline-flex items-center gap-2 px-3 py-1 bg-primary/10 text-primary rounded-full text-sm">
              <span id="selectedPersonName"></span>
              <button type="button" onclick="clearSelectedPerson()" class="hover:text-red-500">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Recipient Count Preview -->
        <div id="recipientPreview" class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
          <div class="flex items-center gap-2 text-blue-800 dark:text-blue-300">
            <i class="fas fa-users"></i>
            <span id="recipientCount">Loading...</span>
          </div>
        </div>

        <!-- Subject -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Subject</label>
          <input
            type="text"
            id="subject"
            name="subject"
            required
            maxlength="255"
            placeholder="Enter message subject..."
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-primary"
          />
        </div>

        <!-- Content -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Message</label>
          <textarea
            id="content"
            name="content"
            required
            rows="6"
            placeholder="Enter your message..."
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-primary resize-none"
          ></textarea>
          <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
            <span id="charCount">0</span> characters
          </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
          <a href="{{ url_for('api_v1.messages_page') }}" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-sm transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Cancel
          </a>
          <div class="flex items-center gap-3">
            <button type="button" onclick="previewMessage()" class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 text-sm transition-colors">
              <i class="fas fa-eye mr-2"></i>Preview
            </button>
            <button type="submit" id="sendBtn" class="px-6 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg text-sm transition-colors">
              <i class="fas fa-paper-plane mr-2"></i>Send Message
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closePreview()"></div>
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-white dark:bg-gray-800 rounded-lg shadow-xl">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Message Preview</h3>
        <button onclick="closePreview()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <div class="mb-4">
          <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Subject</div>
          <div id="previewSubject" class="text-lg font-medium text-gray-900 dark:text-white"></div>
        </div>
        <div class="mb-4">
          <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Message</div>
          <div id="previewContent" class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap bg-gray-50 dark:bg-gray-700 p-3 rounded-lg"></div>
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400">
          <i class="fas fa-users mr-1"></i>
          <span id="previewRecipients"></span>
        </div>
      </div>
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
        <button onclick="closePreview()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
          Close
        </button>
      </div>
    </div>
  </div>
{% endblock %}
{% block extra_js %}
<script src="{{ url_for('static', filename='js/flash.js') }}"></script>
<script>
  const typeRadios = document.querySelectorAll('input[name="message_type"]');
  const estateSelector = document.getElementById('estateSelector');
  const personSelector = document.getElementById('personSelector');
  const estateSelect = document.getElementById('estateSelect');
  const personSearch = document.getElementById('personSearch');
  const personResults = document.getElementById('personResults');
  const selectedPersonId = document.getElementById('selectedPersonId');
  const selectedPerson = document.getElementById('selectedPerson');
  const selectedPersonName = document.getElementById('selectedPersonName');
  const recipientCount = document.getElementById('recipientCount');
  const contentTextarea = document.getElementById('content');
  const charCount = document.getElementById('charCount');

  // Update recipient type display
  function updateRecipientUI() {
    const selectedType = document.querySelector('input[name="message_type"]:checked').value;

    estateSelector.classList.add('hidden');
    personSelector.classList.add('hidden');

    if (selectedType === 'estate') {
      estateSelector.classList.remove('hidden');
    } else if (selectedType === 'individual') {
      personSelector.classList.remove('hidden');
    }

    updateRecipientCount();
  }

  typeRadios.forEach(radio => {
    radio.addEventListener('change', updateRecipientUI);
  });

  estateSelect.addEventListener('change', updateRecipientCount);

  // Character count
  contentTextarea.addEventListener('input', () => {
    charCount.textContent = contentTextarea.value.length;
  });

  // Update recipient count preview
  async function updateRecipientCount() {
    const type = document.querySelector('input[name="message_type"]:checked').value;
    let url = `/api/v1/api/messages/recipient-count?type=${type}`;

    if (type === 'estate' && estateSelect.value) {
      url += `&estate_id=${estateSelect.value}`;
    }

    if (type === 'individual') {
      if (selectedPersonId.value) {
        recipientCount.textContent = '1 recipient will receive this message';
      } else {
        recipientCount.textContent = 'Select a recipient';
      }
      return;
    }

    try {
      const response = await fetch(url);
      const data = await response.json();
      recipientCount.textContent = `${data.count} recipient${data.count !== 1 ? 's' : ''} will receive this message`;
    } catch (error) {
      recipientCount.textContent = 'Unable to calculate recipients';
    }
  }

  // Person search
  let searchTimeout;
  personSearch.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    const query = personSearch.value.trim();

    if (query.length < 2) {
      personResults.classList.add('hidden');
      return;
    }

    searchTimeout = setTimeout(async () => {
      try {
        const response = await fetch(`/api/v1/api/messages/search-persons?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.data.length === 0) {
          personResults.innerHTML = '<div class="p-3 text-sm text-gray-500 dark:text-gray-400">No results found</div>';
        } else {
          personResults.innerHTML = data.data.map(person => `
            <div class="p-3 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer" onclick="selectPerson(${person.id}, '${person.name}', '${person.email}')">
              <div class="text-sm font-medium text-gray-900 dark:text-white">${person.name}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">${person.email}</div>
            </div>
          `).join('');
        }
        personResults.classList.remove('hidden');
      } catch (error) {
        console.error(error);
      }
    }, 300);
  });

  function selectPerson(id, name, email) {
    selectedPersonId.value = id;
    selectedPersonName.textContent = `${name} (${email})`;
    selectedPerson.classList.remove('hidden');
    personSearch.value = '';
    personResults.classList.add('hidden');
    updateRecipientCount();
  }

  function clearSelectedPerson() {
    selectedPersonId.value = '';
    selectedPersonName.textContent = '';
    selectedPerson.classList.add('hidden');
    updateRecipientCount();
  }

  // Close results when clicking outside
  document.addEventListener('click', (e) => {
    if (!personSearch.contains(e.target) && !personResults.contains(e.target)) {
      personResults.classList.add('hidden');
    }
  });

  // Preview
  function previewMessage() {
    const subject = document.getElementById('subject').value;
    const content = document.getElementById('content').value;

    if (!subject || !content) {
      showFlashMessage('Please fill in subject and message', 'error');
      return;
    }

    document.getElementById('previewSubject').textContent = subject;
    document.getElementById('previewContent').textContent = content;
    document.getElementById('previewRecipients').textContent = recipientCount.textContent;
    document.getElementById('previewModal').classList.remove('hidden');
  }

  function closePreview() {
    document.getElementById('previewModal').classList.add('hidden');
  }

  // Submit form
  document.getElementById('composeForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const type = document.querySelector('input[name="message_type"]:checked').value;
    const subject = document.getElementById('subject').value.trim();
    const content = document.getElementById('content').value.trim();
    const sendBtn = document.getElementById('sendBtn');

    // Validation
    if (!subject) {
      showFlashMessage('Please enter a subject', 'error');
      return;
    }
    if (!content) {
      showFlashMessage('Please enter a message', 'error');
      return;
    }
    if (type === 'estate' && !estateSelect.value) {
      showFlashMessage('Please select an estate', 'error');
      return;
    }
    if (type === 'individual' && !selectedPersonId.value) {
      showFlashMessage('Please select a recipient', 'error');
      return;
    }

    // Confirm
    const recipientText = recipientCount.textContent;
    if (!confirm(`Are you sure you want to send this message?\n\n${recipientText}`)) {
      return;
    }

    // Disable button
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';

    try {
      const payload = {
        subject,
        content,
        message_type: type,
      };

      if (type === 'estate') {
        payload.estate_id = parseInt(estateSelect.value);
      } else if (type === 'individual') {
        payload.recipient_person_id = parseInt(selectedPersonId.value);
      }

      const response = await fetch('/api/v1/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (response.ok) {
        showFlashMessage(`Message sent to ${data.recipient_count} recipient(s)!`, 'success', true);
        window.location.href = '{{ url_for("api_v1.messages_page") }}';
      } else {
        showFlashMessage(data.error || 'Failed to send message', 'error');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send Message';
      }
    } catch (error) {
      showFlashMessage('An error occurred', 'error');
      console.error(error);
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send Message';
    }
  });

  // Initial load
  updateRecipientCount();
</script>
{% endblock %}
