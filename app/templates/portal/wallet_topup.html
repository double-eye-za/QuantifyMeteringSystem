{% extends "base.html" %}
{% block title %}Top Up - Portal{% endblock %}
{% block page_title %}Top Up Wallet{% endblock %}
{% block breadcrumb %}
<a href="{{ url_for('portal.portal_dashboard') }}" class="hover:text-primary">Home</a>
<span class="mx-2">/</span>
<a href="{{ url_for('portal.portal_wallet') }}" class="hover:text-primary">Wallet</a>
<span class="mx-2">/</span>
<span>Top Up</span>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
  <!-- Unit Info -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">Unit {{ unit.unit_number }}</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400">Current balance: <span class="font-semibold text-gray-900 dark:text-white">R {{ "%.2f"|format(wallet.balance) }}</span></p>
  </div>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  <div class="mb-4 px-4 py-3 rounded-lg text-sm {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-blue-50 text-blue-700 border border-blue-200{% endif %}">
    {{ message }}
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}

  <form method="POST" action="{{ url_for('portal.portal_wallet_topup_post', unit_id=unit.id) }}" id="topup-form">
    <!-- Utility Type Selection -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
      <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-4">Select Utility</h4>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        {% if 'electricity' in available_utilities %}
        <label class="utility-card cursor-pointer">
          <input type="radio" name="utility_type" value="electricity" class="sr-only peer" checked>
          <div class="rounded-lg border-2 border-gray-200 dark:border-gray-600 p-4 text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 transition-colors">
            <i class="fas fa-bolt text-2xl text-blue-500 mb-2"></i>
            <p class="text-sm font-medium text-gray-900 dark:text-white">Electricity</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">R {{ "%.2f"|format(wallet.electricity_balance) }}</p>
          </div>
        </label>
        {% endif %}
        {% if 'water' in available_utilities %}
        <label class="utility-card cursor-pointer">
          <input type="radio" name="utility_type" value="water" class="sr-only peer" {% if 'electricity' not in available_utilities %}checked{% endif %}>
          <div class="rounded-lg border-2 border-gray-200 dark:border-gray-600 p-4 text-center peer-checked:border-cyan-500 peer-checked:bg-cyan-50 dark:peer-checked:bg-cyan-900/20 transition-colors">
            <i class="fas fa-droplet text-2xl text-cyan-500 mb-2"></i>
            <p class="text-sm font-medium text-gray-900 dark:text-white">Water</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">R {{ "%.2f"|format(wallet.water_balance) }}</p>
          </div>
        </label>
        {% endif %}
        {% if 'solar' in available_utilities %}
        <label class="utility-card cursor-pointer">
          <input type="radio" name="utility_type" value="solar" class="sr-only peer">
          <div class="rounded-lg border-2 border-gray-200 dark:border-gray-600 p-4 text-center peer-checked:border-yellow-500 peer-checked:bg-yellow-50 dark:peer-checked:bg-yellow-900/20 transition-colors">
            <i class="fas fa-sun text-2xl text-yellow-500 mb-2"></i>
            <p class="text-sm font-medium text-gray-900 dark:text-white">Solar</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">R {{ "%.2f"|format(wallet.solar_balance) }}</p>
          </div>
        </label>
        {% endif %}
        {% if 'hot_water' in available_utilities %}
        <label class="utility-card cursor-pointer">
          <input type="radio" name="utility_type" value="hot_water" class="sr-only peer">
          <div class="rounded-lg border-2 border-gray-200 dark:border-gray-600 p-4 text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 dark:peer-checked:bg-orange-900/20 transition-colors">
            <i class="fas fa-fire text-2xl text-orange-500 mb-2"></i>
            <p class="text-sm font-medium text-gray-900 dark:text-white">Hot Water</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">R {{ "%.2f"|format(wallet.hot_water_balance) }}</p>
          </div>
        </label>
        {% endif %}
      </div>
    </div>

    <!-- Amount Selection -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
      <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-4">Top-Up Amount</h4>

      <!-- Preset amounts -->
      <div class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-4">
        {% for preset in [50, 100, 200, 500, 750, 1000] %}
        <button type="button" onclick="setAmount({{ preset }})" class="preset-btn px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-600 text-sm font-medium text-gray-700 dark:text-gray-300 hover:border-primary hover:text-primary transition-colors">
          R {{ preset }}
        </button>
        {% endfor %}
      </div>

      <!-- Custom amount -->
      <div class="relative">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 font-medium">R</span>
        <input type="number" name="amount" id="amount-input" min="10" max="50000" step="0.01" required
          class="w-full pl-8 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-lg font-semibold focus:ring-2 focus:ring-primary focus:border-transparent"
          placeholder="Enter amount">
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Minimum R10, maximum R50,000</p>
    </div>

    <!-- Payment Method -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
      <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-4">Payment Method</h4>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <label class="cursor-pointer">
          <input type="radio" name="payment_method" value="" class="sr-only peer" checked>
          <div class="rounded-lg border-2 border-gray-200 dark:border-gray-600 p-3 text-center peer-checked:border-primary peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 transition-colors">
            <i class="fas fa-wallet text-lg text-gray-500 mb-1"></i>
            <p class="text-xs font-medium text-gray-900 dark:text-white">All Methods</p>
          </div>
        </label>
        <label class="cursor-pointer">
          <input type="radio" name="payment_method" value="cc" class="sr-only peer">
          <div class="rounded-lg border-2 border-gray-200 dark:border-gray-600 p-3 text-center peer-checked:border-primary peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 transition-colors">
            <i class="fas fa-credit-card text-lg text-blue-500 mb-1"></i>
            <p class="text-xs font-medium text-gray-900 dark:text-white">Card</p>
          </div>
        </label>
        <label class="cursor-pointer">
          <input type="radio" name="payment_method" value="eft" class="sr-only peer">
          <div class="rounded-lg border-2 border-gray-200 dark:border-gray-600 p-3 text-center peer-checked:border-primary peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 transition-colors">
            <i class="fas fa-building-columns text-lg text-green-500 mb-1"></i>
            <p class="text-xs font-medium text-gray-900 dark:text-white">EFT</p>
          </div>
        </label>
        <label class="cursor-pointer">
          <input type="radio" name="payment_method" value="dc" class="sr-only peer">
          <div class="rounded-lg border-2 border-gray-200 dark:border-gray-600 p-3 text-center peer-checked:border-primary peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 transition-colors">
            <i class="fas fa-money-bill-transfer text-lg text-purple-500 mb-1"></i>
            <p class="text-xs font-medium text-gray-900 dark:text-white">Instant EFT</p>
          </div>
        </label>
      </div>
    </div>

    <!-- Submit -->
    <button type="submit" id="pay-btn" class="w-full py-3 bg-primary text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
      <i class="fas fa-credit-card"></i>
      <span>Pay with PayFast</span>
    </button>
  </form>
</div>

<script>
function setAmount(value) {
  document.getElementById('amount-input').value = value;
  // Highlight the active preset
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.classList.remove('border-primary', 'text-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
  });
  event.target.classList.add('border-primary', 'text-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
}

document.getElementById('topup-form').addEventListener('submit', function() {
  var btn = document.getElementById('pay-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Processing...</span>';
});
</script>
{% endblock %}
