{% extends "base.html" %}
{% block title %}Payment Complete - Portal{% endblock %}
{% block page_title %}Payment Complete{% endblock %}
{% block breadcrumb %}
<a href="{{ url_for('portal.portal_dashboard') }}" class="hover:text-primary">Home</a>
<span class="mx-2">/</span>
<a href="{{ url_for('portal.portal_wallet') }}" class="hover:text-primary">Wallet</a>
<span class="mx-2">/</span>
<span>Payment Complete</span>
{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-8 text-center">
    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 dark:bg-green-900/20 rounded-full mb-4">
      <i class="fas fa-check text-3xl text-green-600"></i>
    </div>
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Payment Submitted</h2>
    <p class="text-gray-500 dark:text-gray-400 mb-6">
      Your payment has been submitted successfully. Your wallet balance will be updated once the payment is confirmed by PayFast. This usually takes a few seconds.
    </p>

    {% if is_sandbox and pending_txn %}
    <!-- Sandbox helper: manual confirm since PayFast can't reach localhost -->
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4 mb-6 text-left">
      <div class="flex items-start gap-2">
        <i class="fas fa-flask text-yellow-600 mt-0.5"></i>
        <div>
          <p class="text-sm font-semibold text-yellow-800 dark:text-yellow-200">Sandbox Mode</p>
          <p class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">
            PayFast's callback can't reach localhost, so the wallet wasn't credited automatically.
            Click below to manually confirm the transaction.
          </p>
          <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">
            Transaction #{{ pending_txn.transaction_number }} &mdash; R{{ "%.2f"|format(pending_txn.amount) }}
          </p>
          <button id="sandbox-confirm-btn" onclick="sandboxConfirm({{ pending_txn.id }})"
            class="mt-3 px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-lg hover:bg-yellow-700 transition-colors">
            <i class="fas fa-check-circle mr-1"></i> Confirm Payment (Sandbox)
          </button>
          <p id="sandbox-result" class="text-xs mt-2 hidden"></p>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="flex items-center justify-center gap-3">
      <a href="{{ url_for('portal.portal_wallet') }}" class="px-5 py-2.5 bg-primary text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
        <i class="fas fa-wallet mr-1"></i> View Wallet
      </a>
      <a href="{{ url_for('portal.portal_dashboard') }}" class="px-5 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-medium rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
        Dashboard
      </a>
    </div>
  </div>
</div>

{% if is_sandbox and pending_txn %}
<script>
function sandboxConfirm(txnId) {
  var btn = document.getElementById('sandbox-confirm-btn');
  var result = document.getElementById('sandbox-result');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Confirming...';

  fetch('/api/payfast/sandbox-confirm/' + txnId, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
  })
  .then(function(response) { return response.json(); })
  .then(function(data) {
    result.classList.remove('hidden');
    if (data.message) {
      result.className = 'text-xs mt-2 text-green-700 dark:text-green-400';
      result.innerHTML = '<i class="fas fa-check-circle mr-1"></i> ' + data.message + ' â€” R' + data.amount.toFixed(2) + ' credited to ' + data.utility_type;
      btn.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Confirmed';
      btn.className = 'mt-3 px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg cursor-default';
    } else {
      result.className = 'text-xs mt-2 text-red-700 dark:text-red-400';
      result.textContent = data.error || 'Unknown error';
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Confirm Payment (Sandbox)';
    }
  })
  .catch(function(err) {
    result.classList.remove('hidden');
    result.className = 'text-xs mt-2 text-red-700 dark:text-red-400';
    result.textContent = 'Request failed: ' + err.message;
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Confirm Payment (Sandbox)';
  });
}
</script>
{% endif %}
{% endblock %}
