<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Payment</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }
        .container {
            text-align: center;
            padding: 2rem;
        }
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .message { font-size: 1.1rem; color: #555; }
        .error { color: #d32f2f; margin-top: 1rem; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <p class="message" id="message">Loading payment options...</p>
        <p class="error" id="error"></p>
    </div>

    <script>
        (function() {
            var params = new URLSearchParams(window.location.search);
            var uuid = params.get('uuid');
            var sandbox = params.get('sandbox');

            if (!uuid) {
                document.getElementById('spinner').style.display = 'none';
                document.getElementById('message').textContent = 'Error: No payment identifier provided.';
                return;
            }

            // Determine which PayFast engine script to load
            var engineUrl = sandbox === 'true'
                ? 'https://sandbox.payfast.co.za/onsite/engine.js'
                : 'https://www.payfast.co.za/onsite/engine.js';

            // Load the PayFast onsite engine script dynamically
            var script = document.createElement('script');
            script.src = engineUrl;
            script.onload = function() {
                // Script loaded â€” trigger the PayFast payment modal
                document.getElementById('message').textContent = 'Opening payment window...';

                window.payfast_do_onsite_payment(
                    { uuid: uuid },
                    function(result) {
                        if (result === true) {
                            // Payment completed successfully
                            window.location.href = 'https://quantifyit.co.za/payment/completed';
                        } else {
                            // Payment was cancelled or closed
                            window.location.href = 'https://quantifyit.co.za/payment/closed';
                        }
                    }
                );
            };
            script.onerror = function() {
                document.getElementById('spinner').style.display = 'none';
                document.getElementById('message').textContent = 'Failed to load payment gateway.';
                var errorEl = document.getElementById('error');
                errorEl.textContent = 'Please check your internet connection and try again.';
                errorEl.style.display = 'block';
            };
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>
